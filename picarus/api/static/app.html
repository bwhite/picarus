<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>api.picar.us</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">

    <!-- Le styles -->
    <link href="/static/bootstrap.min.css" rel="stylesheet">
    <link href="/static/bootstrap-responsive.min.css" rel="stylesheet">
    <link href="/static/hint.min.css" rel="stylesheet">
    <script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script type="text/javascript" src="//stringencoders.googlecode.com/svn-history/r210/trunk/javascript/base64.js"></script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/2.2.2/bootstrap.min.js"></script>
    <script type="text/javascript" src="//www.google.com/jsapi"></script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.4.4/underscore-min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.3.1/jquery.cookie.min.js"></script>
    <script type="text/javascript" src="/static/picarus_api.js"></script>
    <script type="text/javascript" src="/static/app.js"></script>
    <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBBsKtzgLTIsaoxAFUvSNoJ8n3j4w9VZs0&sensor=false"></script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/backbone.js/0.9.10/backbone-min.js"></script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/mustache.js/0.7.0/mustache.min.js"></script>
    <script src="https://raw.github.com/jsvine/Backbone.Table/master/backbone.table.js"></script>
    
    <style>
      body {
        padding-top: 60px; /* 60px to make the container go all the way to the bottom of the topbar */
      }
      // Models Table
      table { margin: 10px; font-family: Georgia, serif }
      thead, tfoot { background: #D8E2EB; }
      tr.even { background: #F2F4F5; }
      th { font-weight: bold; }
      th, td { padding: 5px 10px; }
      th+th, td+td { border-left: 1px solid #FFF; }
      td.models-inputs {font-size: 8px}
      td.models-params {font-size: 8px}
      td.models-row {font-size: 8px}


    </style>

    <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le fav and touch icons -->
    <link rel="shortcut icon" href="../assets/ico/favicon.ico">
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="../assets/ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../assets/ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../assets/ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="../assets/ico/apple-touch-icon-57-precomposed.png">
  </head>

  <body>
    <div id="tpls">
    <script type="text/html" id="bpl_login">
      <input class="input-small" type="text" placeholder="Email" id="userEmail" value="">
      <input class="input-small" type="password" placeholder="Auth" id="userAuth" value="">
      <input class="input-small" type="checkbox" id="userSave">
    </script>

    <script type="text/html" id="bpl_login_hidden">
      <input type="hidden" id="userEmail" value="">
      <input type="hidden" id="userAuth" value="">
    </script>

    <script type="text/html" id="bpl_row_select">
          <select id="rowPrefixDrop"></select>
          <span class="hint hint--bottom" data-hint="Start row (inclusive, percent encode binary)"><input class="input-small" type="text" placeholder="Row start" id="startRow"></span>
          <span class="hint hint--bottom" data-hint="Stop row (exclusive, percent encode binary)"><input class="input-small" type="text" placeholder="Row stop" id="stopRow"></span>
    </script>

    <script type="text/html" id="bpl_filter">
      <span class="hint hint--bottom" data-hint="Filter (see Docs/Filters)"><input class="input-large" type="text" placeholder="Filter" id="filter" value=""></span>
    </script>

    <script type="text/html" id="bpl_prefix_select">
          <select id="rowPrefixDrop"></select>
    </script>


    <script type="text/html" id="tpl_home">
      <div id="users"></div>
    </script>

    <script type="text/javascript">
      function render_home() {
          users = new PicarusUsers();
          var AppView = Backbone.View.extend({
              initialize: function() {
                  _.bindAll(this, 'render');
                  this.collection.bind('reset', this.render);
                  this.collection.bind('change', this.render);
              },
              render: function() {
                          picarus_table = new Backbone.Table({
                          collection: this.collection,
                          columns: [["email", "Email"],
                                    ["uploadRowPrefix", "Row Prefix"],
                                    {header: "Prefixes", getFormatted: function() { return _.escape(JSON.stringify(this.get('imagePrefixes')))}}]
                          });
                          this.$el.html(picarus_table.render().el);
                      }
          });
          new AppView({collection: users, el: $('#users')});
          login_get(function (email_auth) {
              var user = new PicarusUser({email: email_auth.email});
              users.add(user);
              user.fetch();
          });
      }
    </script>

<!--
    <script type="text/html" id="tpl_data_explore">
    </script>

    <script type="text/javascript">
    </script>
-->

    <script type="text/html" id="tpl_data_uploads">
      <div id="images"></div>
    </script> 

    <script type="text/javascript">
      function render_data_uploads() {
          function success_user(xhr) {
              var response = JSON.parse(xhr.responseText);
              var startRow = response.uploadRowPrefix;
              var imageColumn = encode_id('thum:image_150sq');
              function success(row, columns) {
                  $('#images').append(escape(decode_id(row)));
                  $('#images').append($('<br>'));
                  $('#images').append($('<img>').attr('src', 'data:image/jpeg;base64,' + columns[imageColumn]).attr('width', '150px'));
                  $('#images').append($('<br>'));
              }
              picarus_api_data_scanner("images", encode_id(startRow), encode_id(prefix_to_stop_row(startRow)), [imageColumn], {success: success, maxRows: 100});
          }
          picarus_api("/a1/user", "GET", {success: success_user});
       }
    </script>

<!--
    <script type="text/html" id="tpl_data_import">
    </script> 

    <script type="text/html" id="tpl_data_export">
    </script> 
   
    <script type="text/html" id="tpl_triage_categorize">
    </script>
 
    <script type="text/html" id="tpl_triage_summarize">
    </script>
 -->

    <script type="text/html" id="tpl_crawl_flickr">
      <%=prefixSelect%>
      <input class="input-small" type="text" placeholder="Iterations" id="demoiters" value="1">
      <input class="input-large" type="text" placeholder="Class Name" id="democlass" value="">
      <input class="input-large" type="text" placeholder="Query" id="demoquery" value="">
      <input class="input-small" type="checkbox" id="demogeo" checked> Geotagged
      <button class="btn" type="submit" id="runButton" style="margin-bottom: 9px">Run</button>
      <div class="progress progress-striped active" id="progress_bar">
        <div class="bar" style="width: 0%;"  id="progress"></div>
      </div>
    </script>

    <script type="text/javascript">
      function render_crawl_flickr() {
      row_selector();
      $('#runButton').click(function () {
          var demo_class = $('#democlass').val();
          var row_prefix = $('#rowPrefixDrop').val();
          if (demo_class.length == 0 && row_prefix.length == 0) {
              display_alert('Must specify class and prefix');
              return;
          }
          var iters = parseInt($('#demoiters').val())
          var iters_orig = iters;
          if (isNaN(iters) || iters < 1 || iters > 1000) {
              display_alert('Iters must be 0 < x <= 1000');
              return;
          }
          /* Check input */
          //reset_state();
          var min_time = 1232170610;
          var min_upload_date = parseInt((new Date().getTime() / 1000 - min_time) * Math.random() + min_time);
          var max_upload_date = parseInt((new Date().getTime() / 1000 - min_upload_date) * Math.random() + min_upload_date);
          var auth = {email: $('#demouser').val(), auth: $('#demopass').val()};
          function call_api() {
              $('#progress').css('width', ((100. * (iters_orig - iters)) / iters_orig) + '%');
              picarus_api("/a1/slice/images/" + encode_id(row_prefix) + '/' + encode_id(prefix_to_stop_row(row_prefix)), "POST", {success: success, data: {hasGeo: Number($('#demogeo').is(':checked')), className: demo_class, minUploadDate: min_upload_date, maxUploadDate: max_upload_date, action: 'o/crawl/flickr'}});
          }
          function success() {
              console.log('Calling iter')
              if (iters > 0) {
                  iters -= 1;
                  call_api(1);
              } else {
                  alert('Done crawling');
              }
          }
          call_api(1);
      });


      }
    </script>

    <script type="text/html" id="tpl_models_list">
      <div id="models"></div>
      <div id="myModal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-hidden="true">Ã—</button>
          <h3 id="myModalLabel" id="modal_header"></h3>
        </div>
        <div class="modal-body">
          <textarea id="modal_content" style="width: 100%; height: 100%; box-sizing: border-box;  resize: none; "></textarea>
        </div>
        <div class="modal-footer">
          <button class="btn" data-dismiss="modal" aria-hidden="true" id="close_button">Close</button>
          <button class="btn btn-primary" id="save_button">Save changes</button>
        </div>
      </div>
    <div id="container" class="container"></div>
    </script>
    
    <script type="text/javascript">
      function render_models_list() {
          models = new PicarusModels();
          var AppView = Backbone.View.extend({
              el: $('#container'),
              initialize: function() {
                  _.bindAll(this, 'render');
                  this.collection.bind('reset', this.render);
                  this.collection.bind('change', this.render);
              },
              render: function() {
                          picarus_table = new Backbone.Table({
                          collection: this.collection,
                          columns: [["name", "Name"], 
                                    {header: "Notes", className: "models-notes", getFormatted: function() { return this.escape('notes') + '<span style="font-size:5px"><a class="modal_link_notes" row="' + this.escape('row') + '">edit</a></span>'}},
                                    {header: "Tags", className: "models-tags", getFormatted: function() { return this.escape('tags') + '<span style="font-size:5px"><a class="modal_link_tags" row="' + this.escape('row') + '">edit</a></span>'}},
                                    ["prefix_pretty", "Type"], ["creationTime", "Creation"],
                                    {header: "Row", className: "models-row", getFormatted: function() { return this.escape('row')}},
                                    {header: "Parameters", className: "models-params", getFormatted: function() { return _.escape(JSON.stringify(this.get('param')))}},
                                    {header: "Inputs", className: "models-inputs", getFormatted: function() { return _.escape(JSON.stringify(this.get('inputs')))}}]
                          });
                          $("#models").html(picarus_table.render().el);
                          $('.modal_link_notes').click(function (data) {
                              var row = data.target.getAttribute('row');
                              var model = models.get(row);
                              $('#modal_content').val(model.escape('notes'));
                              $('#save_button').unbind();
                              $('#save_button').click(function () {
                                  model.save({notes: $('#modal_content').val()}, {patch: true});
                                  $('#myModal').modal('hide')
                              });
                              $('#myModal').modal('show')
                          })
                          $('.modal_link_tags').click(function (data) {
                              var row = data.target.getAttribute('row');
                              var model = models.get(row);
                              $('#modal_content').val(model.escape('tags'));
                              $('#save_button').unbind();
                              $('#save_button').click(function () {
                                  model.save({tags: $('#modal_content').val()}, {patch: true});
                                  $('#myModal').modal('hide')
                              });
                              $('#myModal').modal('show')
                          })
                      }
          });
          new AppView({ collection: models });
          models.fetch();
      }
    </script>

    <script type="text/html" id="tpl_models_create">
        <div id="selects">
            <select id="type_select"></select>
            <select id="name_select"></select>
            <div id="params"></div>
            <div id="row_select"></div>
        </div>
        <button class="btn" type="submit" id="runButton" style="margin-bottom: 9px">Run</button>
        <div id="results"></div>
    </script>
    <script type="text/javascript">
      function add_hint(el, text) {
          el.wrap($('<span>').attr('class', 'hint hint--bottom').attr('data-hint', text));
      }
      function render_models_create() {
          PicarusParamModel = Backbone.Model.extend({
              idAttribute: "path",
          });
          PicarusParamModels = Backbone.Collection.extend({
              model : PicarusParamModel,
              url : "/a1/params"
          });
          models = new PicarusParamModels();
          var AppView = Backbone.View.extend({
              initialize: function() {
                  _.bindAll(this, 'renderType');
                  _.bindAll(this, 'renderName');
                  this.collection.bind('reset', this.renderType);
                  this.collection.bind('change', this.renderType);
                  this.collection.bind('add', this.renderType);
              },
              events: {'change #type_select': 'renderName',
                       'change #name_select': 'renderParam'},
              renderParam: function () {
                  $('#params').html('');
                  $('#row_select').html('');
                  var model_type = $('#type_select option:selected').val();
                  var name = $('#name_select option:selected').val();
                  model = this.collection.where({type: model_type, name: name})[0];

                  function add_param_selections(params, param_prefix) {
                      _.each(params, function (value, key) {
                          var cur_el;
                          if (value.type == 'enum') {
                              var select_template = "{{#models}}<option value='{{.}}'>{{.}}</option>{{/models}};"
                              cur_el = $('<select>').attr('name', param_prefix + key).html(Mustache.render(select_template, {models: value.values}));
                          } else if (value.type == 'int') {
                              // TODO: Client-side data validation
                              cur_el = $('<input>').attr('name', param_prefix + key).attr('type', 'text');
                          } else if (value.type == 'str') {
                              // TODO: Client-side data validation
                              cur_el = $('<input>').attr('name', param_prefix + key).attr('type', 'text');
                          }
                          if (typeof cur_el !== 'undefined') {
                              $('#params').append(cur_el);
                              add_hint(cur_el, key);
                          }
                      });
                  }
                  add_param_selections(model.get('modelParams'), 'model-');
                  add_param_selections(model.get('moduleParams'), 'module-');
                  if (model.get('data') === 'slice') {
                      $('#row_select').append(document.getElementById('bpl_row_select').innerHTML);
                      row_selector();
                  }
                  _.each(model.get('inputs'), function (value) {
                      var cur_el;
                      // TODO: Finish model inputs, figure out how to take the values from here and integrate them in the response
                      if (value === 'processed_image') {
                          var cur_id = _.uniqueId('model_select_');
                          $('#params').append($('<select>').attr('id', cur_id).attr('name', 'key-' + value));
                          model_dropdown({modelFilter: function (x) {return x.get('prefix') === 'data:'},
                                          change: function() {},
                                          el: $('#' + cur_id)});
                      } else if (value === 'feature') {
                          var cur_id = _.uniqueId('model_select_');
                          $('#params').append($('<select>').attr('id', cur_id).attr('name', 'key-' + value));
                          model_dropdown({modelFilter: function (x) {return x.get('prefix') === 'feat:'},
                                          change: function() {},
                                          el: $('#' + cur_id)});
                      } else if (value === 'multi_feature') {
                          var cur_id = _.uniqueId('model_select_');
                          $('#params').append($('<select>').attr('id', cur_id).attr('name', 'key-' + value));
                          model_dropdown({modelFilter: function (x) {return x.get('prefix') === 'mfeat:'},
                                          change: function() {},
                                          el: $('#' + cur_id)});
                      } else if (value === 'hash') {
                          var cur_id = _.uniqueId('model_select_');
                          $('#params').append($('<select>').attr('id', cur_id).attr('name', 'key-' + value));
                          model_dropdown({modelFilter: function (x) {return x.get('prefix') === 'hash:'},
                                          change: function() {},
                                          el: $('#' + cur_id)});
                      } else if (value === 'raw_image') {
                          $('#params').append($('<input>').attr('name', 'key-' + value).attr('type', 'hidden').val(encode_id('data:image')));
                      } else if (value === 'meta') {
                          var cur_id = _.uniqueId('model_select_');
                          //
                          var el = $('<select>').attr('id', cur_id).attr('name', 'key-' + value);
                          _.each(['meta:class', 'meta:class_0', 'meta:class_1', 'meta:class_2'], function (x) {
                              el.append($('<option>').attr('value', encode_id(x)).text(x))
                          });
                          $('#params').append(el);
                      }

                  });
              },
              renderName: function () {
                  var model_type = $('#type_select option:selected').val();
                  var cur_models = this.collection.where({type: model_type});
                  var select_template = "{{#models}}<option value='{{type}}'>{{type}}</option>{{/models}};"
                  var models_filt = _.map(cur_models, function (data) {return {type: data.get('name')}});
                  $('#name_select').html(Mustache.render(select_template, {models: models_filt}));
                  this.renderParam();
              },
              renderType: function() {
                  var select_template = "{{#models}}<option value='{{type}}'>{{type}}</option>{{/models}};"
                  var models_filt = _.uniq(_.map(this.collection.models, function (data) {return {type: data.get('type')}}));
                  $('#type_select').html(Mustache.render(select_template, {models: models_filt}));
                  this.renderName();
              }
         });
         av = new AppView({collection: models, el: $('#selects')});
         models.fetch();
         $('#runButton').click(function () {
             var params = _.object($('#params :input').map(function () {return [[$(this).attr('name'), $(this).val()]]}));
             function success(xhr) {
                 response = JSON.parse(xhr.responseText);
                 $('#results').html(response.row);
             }
             var model_type = $('#type_select option:selected').val();
             var name = $('#name_select option:selected').val();
             var model = models.where({type: model_type, name: name})[0];
             var path = model.get('path');
             if (model.get('data') === 'slice') {
                 var startRow = encode_id($('#startRow').val());
                 var stopRow = encode_id($('#stopRow').val());
                 params.action = 'i/train/' + path
                 picarus_api("/a1/slice/images/" + startRow + '/' + stopRow, "POST", {success: success, data: params});
             } else {
                 picarus_api("/a1/models/" + path, "POST", {success: success, data: params});
             }
         });
      }
    </script>

    <script type="text/html" id="tpl_process_thumbnail">
      <%=rowSelect%>
      <button class="btn" type="submit" id="runButton" style="margin-bottom: 9px">Run</button>
      <div id="results"></div>
    </script>

    <script type="text/javascript">
      function alert_running() {
          $('#results').html('<div class="alert alert-info"><strong>Running!</strong> Job is running, please wait...</div>');
      }
      function alert_done() {
          $('#results').html('<div class="alert alert-success"><strong>Done!</strong> Job is done.</div>');
      }
      function render_process_thumbnail() {
          row_selector();
          $('#runButton').click(function () {
              alert_running();
              var startRow = encode_id($('#startRow').val());
              var stopRow = encode_id($('#stopRow').val());
              function success() {
                  alert_done();
              }
              picarus_api("/a1/slice/images/" + startRow + '/' + stopRow, "POST", {success: success, data: {action: 'io/thumbnail'}});
          });
      }
    </script>

    <script type="text/html" id="tpl_process_exif">
      <%=rowSelect%>
      <button class="btn" type="submit" id="runButton" style="margin-bottom: 9px">Run</button>
      <div id="results"></div>
    </script>

    <script type="text/javascript">
      function render_process_exif() {
          row_selector();
          $('#runButton').click(function () {
              alert_running();
              var startRow = encode_id($('#startRow').val());
              var stopRow = encode_id($('#stopRow').val());
              function success() {
                  alert_done();
              }
              picarus_api("/a1/slice/images/" + startRow + '/' + stopRow, "POST", {success: success, data: {action: 'io/exif'}});
          });
      }
    </script>

    <script type="text/html" id="tpl_process_modify">
      <%=rowSelect%>
      <input class="input-small" type="text" placeholder="Column" id="columnName" value="">
      <input class="input-small" type="text" placeholder="Value" id="columnValue" value="">
      <button class="btn" type="submit" id="runButton" style="margin-bottom: 9px">Run</button>
      <div id="results"></div>
    </script>

    <script type="text/javascript">
      function render_process_modify() {
          row_selector();
          $('#runButton').click(function () {
              alert_running();
              var columnName = encode_id($('#columnName').val());
              var columnValue = $('#columnValue').val();
              var startRow = encode_id($('#startRow').val());
              var stopRow = encode_id($('#stopRow').val());
              function success() {
                  alert_done();
              }
              var data = {};
              data[columnName] = columnValue
              picarus_api("/a1/slice/images/" + startRow + '/' + stopRow, "PATCH", {success: success, data: data});
          });
      }
    </script>

    <script type="text/html" id="tpl_process_copy">
      <%=rowSelect%>
      <%=rowSelect%>
      <button class="btn" type="submit" id="runButton" style="margin-bottom: 9px">Run</div>
      <button id="results"></div>
    </script>

    <script type="text/javascript">
      function render_process_copy() {
          row_selector();
          $('#runButton').click(function () {
              alert_running();
              var columnName = encode_id($('#columnName').val());
              var columnValue = $('#columnValue').val();
              var startRow = encode_id($('#startRow').val());
              var stopRow = encode_id($('#stopRow').val());
              function success() {
                  alert_done();
              }
              var data = {};
              data[columnName] = columnValue
              picarus_api("/a1/slice/images/" + startRow + '/' + stopRow, "PATCH", {success: success, data: data});
          });
      }
    </script>

    <script type="text/html" id="tpl_process_preprocess">
      <select id="model_select"></select>
      <%=rowSelect%>
      <button class="btn" type="submit" id="runButton" style="margin-bottom: 9px">Run</button>
      <div id="results"></div>
    </script>

    <script type="text/javascript">
      function alert_running() {
          $('#results').html('<div class="alert alert-info"><strong>Running!</strong> Job is running, please wait...</div>');
      }
      function alert_done() {
          $('#results').html('<div class="alert alert-success"><strong>Done!</strong> Job is done.</div>');
      }
      function render_process_preprocess() {
          model_dropdown({modelFilter: function (x) {return x.get('prefix') === 'data:'},
                          el: $('#model_select')});
          row_selector();
          $('#runButton').click(function () {
              alert_running();
              var startRow = encode_id($('#startRow').val());
              var stopRow = encode_id($('#stopRow').val());
              function success() {
                  alert_done();
              }
              var data = {action: 'io/preprocess', model: $('#model_select').find(":selected").val()};
              picarus_api("/a1/slice/images/" + startRow + '/' + stopRow, "POST", {success: success, data: data});
          });
      }
    </script>

    <script type="text/html" id="tpl_process_feature">
      <select id="model_select"></select>
      <%=rowSelect%>
      <button class="btn" type="submit" id="runButton" style="margin-bottom: 9px">Run</button>
      <div id="results"></div>
    </script>

    <script type="text/javascript">
      function render_process_feature() {
          model_dropdown({modelFilter: function (x) {return x.get('prefix') === 'feat:' || x.get('prefix') === 'mfeat:'},
                          el: $('#model_select')});
          row_selector();
          $('#runButton').click(function () {
              alert_running();
              var startRow = encode_id($('#startRow').val());
              var stopRow = encode_id($('#stopRow').val());
              function success() {
                  alert_done();
              }
              var data = {action: 'io/feature', model: $('#model_select').find(":selected").val()};
              picarus_api("/a1/slice/images/" + startRow + '/' + stopRow, "POST", {success: success, data: data});
          });
      }
    </script>

    <script type="text/html" id="tpl_process_classifier">
      <select id="model_select"></select>
      <%=rowSelect%>
      <button class="btn" type="submit" id="runButton" style="margin-bottom: 9px">Run</button>
      <div id="results"></div>
    </script>

    <script type="text/javascript">
      function render_process_classifier() {
          model_dropdown({modelFilter: function (x) {return x.get('prefix') === 'pred:'},
                          el: $('#model_select')});
          row_selector();
          $('#runButton').click(function () {
              alert_running();
              var startRow = encode_id($('#startRow').val());
              var stopRow = encode_id($('#stopRow').val());
              function success() {
                  alert_done();
              }
              var data = {action: 'io/classify', model: $('#model_select').find(":selected").val()};
              picarus_api("/a1/slice/images/" + startRow + '/' + stopRow, "POST", {success: success, data: data});
          });
      }
    </script>

    <script type="text/html" id="tpl_process_hash">
      <select id="model_select"></select>
      <%=rowSelect%>
      <button class="btn" type="submit" id="runButton" style="margin-bottom: 9px">Run</button>
      <div id="results"></div>
    </script>

    <script type="text/javascript">
      function render_process_hash() {
          model_dropdown({modelFilter: function (x) {return x.get('prefix') === 'hash:'},
                          el: $('#model_select')});
          row_selector();
          $('#runButton').click(function () {
              alert_running();
              var startRow = encode_id($('#startRow').val());
              var stopRow = encode_id($('#stopRow').val());
              function success() {
                  alert_done();
              }
              var data = {action: 'io/hash', model: $('#model_select').find(":selected").val()};
              picarus_api("/a1/slice/images/" + startRow + '/' + stopRow, "POST", {success: success, data: data});
          });
      }
    </script>

    <script type="text/html" id="tpl_annotate_entity">
      <%=rowSelect%>
      <button class="btn" type="submit" id="runButton" style="margin-bottom: 9px">Run</button>
      <div id="response"></div>
    </script>

    <script type="text/javascript">
      function render_annotate_entity() {
          row_selector();
          $('#runButton').click(function () {
              var startRow = encode_id($('#startRow').val());
              var stopRow = encode_id($('#stopRow').val());
              var imageColumn = encode_id('thum:image_150sq');
              var entityColumn = encode_id('meta:class');
              function success(xhr) {
                  response = JSON.parse(xhr.responseText);
                  $('#response').append($('<a>').attr('href', response.worker).text('Worker').attr('target', '_blank'));
                  $('#response').append($('<br>'));
                  $('#response').append($('<a>').attr('href', response.results).text('Results').attr('target', '_blank'));
                  $('#response').append($('<br>'));
                  $('#response').append($('<a>').attr('href', response.results).text('Users').attr('target', '_blank'));
                  $('#response').append($('<br>'));
                  $('#response').append($('<a>').attr('href', response.stop).text('Stop').attr('target', '_blank'));
                  $('#response').append($('<br>'));
              }
              picarus_api("/a1/slice/images/" + startRow + '/' + stopRow, "POST", {success: success, data: {action: 'io/annotate/image/entity', imageColumn: imageColumn, entityColumn: entityColumn}});
          });
      }
    </script>

    <script type="text/html" id="tpl_annotate_query">
      <%=rowSelect%>
      <input class="input-small" type="text" placeholder="Query" id="query" value="">
      <button class="btn" type="submit" id="runButton" style="margin-bottom: 9px">Run</button>
      <div id="response"></div>
    </script>

    <script type="text/javascript">
      function render_annotate_query() {
          row_selector();
          $('#runButton').click(function () {
              var startRow = encode_id($('#startRow').val());
              var stopRow = encode_id($('#stopRow').val());
              var imageColumn = encode_id('thum:image_150sq');
              var entityColumn = encode_id('meta:class');
              var query = $('#query').val();
              function success(xhr) {
                  response = JSON.parse(xhr.responseText);
                  $('#response').append($('<a>').attr('href', response.worker).text('Worker').attr('target', '_blank'));
                  $('#response').append($('<br>'));
                  $('#response').append($('<a>').attr('href', response.results).text('Results').attr('target', '_blank'));
                  $('#response').append($('<br>'));
                  $('#response').append($('<a>').attr('href', response.results).text('Users').attr('target', '_blank'));
                  $('#response').append($('<br>'));
                  $('#response').append($('<a>').attr('href', response.stop).text('Stop').attr('target', '_blank'));
                  $('#response').append($('<br>'));
              }
              picarus_api("/a1/slice/images/" + startRow + '/' + stopRow, "POST", {success: success, data: {action: 'io/annotate/image/query', imageColumn: imageColumn, entityColumn: entityColumn, query: query}});
          });
      }
    </script>

    <script type="text/html" id="tpl_annotate_batch">
      <%=rowSelect%>
      <input class="input-small" type="text" placeholder="Query" id="query" value="">
      <button class="btn" type="submit" id="runButton" style="margin-bottom: 9px">Run</button>
      <div id="response"></div>
    </script>

    <script type="text/javascript">
      function render_annotate_batch() {
          row_selector();
          $('#runButton').click(function () {
              var startRow = encode_id($('#startRow').val());
              var stopRow = encode_id($('#stopRow').val());
              var imageColumn = encode_id('thum:image_150sq');
              var entityColumn = encode_id('meta:class');
              var query = $('#query').val();
              function success(xhr) {
                  response = JSON.parse(xhr.responseText);
                  $('#response').append($('<a>').attr('href', response.worker).text('Worker').attr('target', '_blank'));
                  $('#response').append($('<br>'));
                  $('#response').append($('<a>').attr('href', response.results).text('Results').attr('target', '_blank'));
                  $('#response').append($('<br>'));
                  $('#response').append($('<a>').attr('href', response.results).text('Users').attr('target', '_blank'));
                  $('#response').append($('<br>'));
                  $('#response').append($('<a>').attr('href', response.stop).text('Stop').attr('target', '_blank'));
                  $('#response').append($('<br>'));
              }
              picarus_api("/a1/slice/images/" + startRow + '/' + stopRow, "POST", {success: success, data: {action: 'io/annotate/image/query_batch', imageColumn: imageColumn, entityColumn: entityColumn, query: query}});
          });
      }
    </script>

    <script type="text/html" id="tpl_classifier_compute">
      <div class="hero-unit" style="padding-top: 10px; padding-bottom: 10px; padding-left: 10px; padding-right: 10px;">
        <select id="model_select"></select>
        <input type="file" id="imagefile" class="input-small">
      </div>
      <div id="results">
      </div>
    </script>

    <script type="text/javascript">
      function render_classifier_compute() {
          model_dropdown({modelFilter: function (x) {return x.get('prefix') === 'pred:'},
                          change: function() {},
                          el: $('#model_select')});

          $('#imagefile').change(function () {
              if ($('#imagefile')[0].files.length != 1) {
                  display_alert('You must specify an image!');
                  return;
              }
              var imageColumn = encode_id('data:image');
              var modelKey = $('#model_select').find(":selected").val();
              function success_func(xhr) {
                  $('#results').html(xhr.responseText);
              }
              function upload_func(xhr) {
                  var response = JSON.parse(xhr.responseText);
                  picarus_api_row(table, response.row, "POST", {data: {imageColumn: imageColumn, action: 'i/classify', model: modelKey}, success: success_func})
              }
              var table = 'images';
              var data = {};
              data[imageColumn] = $('#imagefile')[0].files[0];
              picarus_api_upload(table, {data: data, success: upload_func})
              
          });
      }
    </script>

    <script type="text/html" id="tpl_classifier_evaluate">
      <div>
        <select id="model_select"></select>
      <%=rowSelect%>
      <input class="input-small" type="text" placeholder="Positive Class" id="posClass" value="" readonly="readonly">
      <input class="input-small" type="text" placeholder="GT Column" id="gtColumn" readonly="readonly" value="" >
      <input class="input-small" type="text" placeholder="Classifier Key" id="modelKey" value="" readonly="readonly">
      <button class="btn" type="submit" id="runButton" style="margin-bottom: 9px">Run</button>
      </div>
      <div class="progress progress-striped active" id="progress_bar">
        <div class="bar" style="width: 0%;"  id="progress"></div>
      </div>
      <div id="base" style="position:relative;top:-35px;"></div>
      <div id="graph_confidence_scatter" style="height:200px;width:600px"></div>
      <div id="graph_confidence_scatter_norm" style="height:200px;width:600px"></div>
      <div id="graph_confidence_accuracy" style="height:200px;width:600px"></div>
      <div id="graph_rps" style="height:300px;width:300px;float:left;"></div>
      <div id="graph_roc" style="height:300px;width:300px;float:left;"></div>
    </script>
    <script type="text/javascript">
      function render_classifier_evaluate() {
          model_dropdown({modelFilter: function (x) {return x.get('prefix') === 'pred:' && x.get('param').classifier_type === "c2tsZWFybl9kZWNpc2lvbl9mdW5j"},
                          change: function() {
                              var row = this.$el.find(":selected").val();
                              m = this.collection.get(row);
                              $('#gtColumn').val(base64.decode(m.get('inputs').meta));
                              $('#posClass').val(base64.decode(m.get('param').class_positive));
                              $('#modelKey').val(row);
                          },
                          el: $('#model_select')});
          row_selector();
          $('#runButton').click(function () {
          confs = {pos_confs: [], neg_confs: []};
          var gt_column = encode_id($('#gtColumn').val());
          var conf_column = $('#modelKey').val();
          var startRow = encode_id($('#startRow').val());
          var stopRow = encode_id($('#stopRow').val());
          var posClass = $('#posClass').val();
          $('#progress_bar').show()
          function success(row, columns) {
              $('#progress').css('width', (100 * (confs.pos_confs.length + confs.neg_confs.length) / 19850.) + '%')
              if (columns.hasOwnProperty(conf_column)) {
                  if (base64.decode(columns[gt_column]) == posClass) {
                      confs.pos_confs.push(Number(base64.decode(columns[conf_column])));
                  } else {
                      confs.neg_confs.push(Number(base64.decode(columns[conf_column])));
                  }
              } else {
                  console.log('Row without confidence');
              }
          }
              function success_confs() {
                  $('#progress_bar').hide()
                  confs.neg_confs.sort(function(a, b) {return a - b});
                  confs.pos_confs.sort(function(a, b) {return a - b});
                  plot_confs(confs);
              }
              picarus_api_data_scanner("images", startRow, stopRow, [gt_column, conf_column], {success: success, done: success_confs});
          })
      }
      function confs_to_conf_hist(pos_confs, neg_confs, bins, normalize) {
          /* Takes in confs, produces a histogram capturing both pos/neg confs in each bin
             TODO: Check that each bin gets get an equal portion of the range
           */
          var min_conf = Math.min(pos_confs[0], neg_confs[0]);
          var max_conf = Math.min(pos_confs[pos_confs.length - 1], neg_confs[neg_confs.length - 1]);
          var shift = min_conf;
          var scale = bins / (max_conf - min_conf);
          var pos_buckets = [];
          var neg_buckets = [];
          var coords = [];
          var i, cur_bucket;
          for (i = 0; i < bins; i++) {
              pos_buckets[i] = 0;
              neg_buckets[i] = 0;
          }
          for (i = 0; i < pos_confs.length; i++) {
              pos_buckets[Math.min(bins - 1, Math.max(0, Math.floor((pos_confs[i] - shift) * scale)))] += 1;
          }
          for (i = 0; i < neg_confs.length; i++) {
              neg_buckets[Math.min(bins - 1, Math.max(0, Math.floor((neg_confs[i] - shift) * scale)))] += 1;
          }
          for (i = 0; i < bins; i++) {
              coords[i] = [(i + .5) / scale + shift, pos_buckets[i], neg_buckets[i]];
              if (normalize) {
                  coords[i][1] /= pos_confs.length;
                  coords[i][2] /= neg_confs.length;
              }
          }
          return coords;
      }
      function test_confs_to_confusion_matrix() {
          //var cms;
          cms = confs_to_confusion_matrix([], []);
          if (!_.isEqual(cms, []))
              return 1;

          cms = confs_to_confusion_matrix([0], []);
          if (!_.isEqual(cms, [[1, 0, 0, 0, 0]]))
              return 2;

          cms = confs_to_confusion_matrix([], [0]);
          if (!_.isEqual(cms, [[0, 0, 1, 0, Infinity]]))
              return 3;

          cms = confs_to_confusion_matrix([0], [0]);
          if (!_.isEqual(cms, [[1, 1, 0, 0, 0], [0, 0, 1, 1, Infinity]]))
              return 4;

          cms = confs_to_confusion_matrix([1], [0]);
          if (!_.isEqual(cms, [[1, 0, 1, 0, 1]]))
              return 5;

          cms = confs_to_confusion_matrix([0], [1]);
          if (!_.isEqual(cms, [[1, 1, 0, 0, 0], [0, 0, 1, 1, Infinity]]))
              return 6;

          cms = confs_to_confusion_matrix([0, 0], [0]);
          if (!_.isEqual(cms, [[2, 1, 0, 0, 0], [0, 0, 1, 2, Infinity]]))
              return 7;

          cms = confs_to_confusion_matrix([0, 1], [0]);
          if (!_.isEqual(cms, [[2, 1, 0, 0, 0], [1, 0, 1, 1, 1]]))
              return 8;

          cms = confs_to_confusion_matrix([0, 0], [1]);
          if (!_.isEqual(cms, [[2, 1, 0, 0, 0], [0, 0, 1, 2, Infinity]]))
              return 9;

          cms = confs_to_confusion_matrix([1, 2], [0]);
          if (!_.isEqual(cms, [[2, 0, 1, 0, 1]]))
              return 10;

          cms = confs_to_confusion_matrix([0, 2], [1]);
          if (!_.isEqual(cms, [[2, 1, 0, 0, 0], [1, 0, 1, 1, 2]]))
              return 11;

          cms = confs_to_confusion_matrix([0, 1], [2]);
          if (!_.isEqual(cms, [[2, 1, 0, 0, 0], [0, 0, 1, 2, Infinity]]))
              return 12;

          cms = confs_to_confusion_matrix([1, 2], [0, 3]);
          if (!_.isEqual(cms, [[2, 1, 1, 0, 1], [0, 0, 2, 2, Infinity]]))
              return 13;

          cms = confs_to_confusion_matrix([1, 2, 3], [0, 3]);
          if (!_.isEqual(cms, [[3, 1, 1, 0, 1], [0, 0, 2, 3, Infinity]]))
              return 14;

          cms = confs_to_confusion_matrix([1, 2, 3, 3], [0, 3]);
          if (!_.isEqual(cms, [[4, 1, 1, 0, 1], [0, 0, 2, 4, Infinity]]))
              return 15;
          return 0;
      }
      function confs_to_confusion_matrix(pos_confs, neg_confs) {
          /* Takes in confs, produces list of [tp, fp, tn, fn, thresh] */
          var cm_threshs = [];
          var fn = 0;
          var tn = 0;
          var i;
          var cur_thresh;
          while (pos_confs.length || neg_confs.length) {
              // Skip Negatives
              for (i = 0; i < neg_confs.length; i++) {
                  if (neg_confs[i] >= pos_confs[0]) {
                      break;
                  }
              }
              neg_confs = neg_confs.slice(i, neg_confs.length);
              tn += i;
              // Add PR point (cur_thresh = pos_confs[0])
              if (pos_confs.length) {
                  cur_thresh = pos_confs[0];
              } else {
                  cur_thresh = Infinity;
              }
              cm_threshs.push([pos_confs.length, neg_confs.length, tn, fn, cur_thresh]);
              // Skip Positives
              for (i = 0; i < pos_confs.length; i++) {
                  if (pos_confs[i] > neg_confs[0]) {
                      break;
                  }
              }
              pos_confs = pos_confs.slice(i, pos_confs.length);
              fn += i;
          }
          return cm_threshs;
      }
      function cms_to_rps(cms) {
          var rps = [];
          var i;
          for (i = 0; i < cms.length; i++) {
              rps.push([cms[i][0] / (cms[i][0] + cms[i][3]), cms[i][0] / (cms[i][0] + cms[i][1]), cms[i][4]])
          }
          return rps;
      }
      function cms_to_conf_accs(cms) {
          var conf_accs = [];
          var i;
          for (i = 0; i < cms.length; i++) {
              conf_accs.push([cms[i][4], (cms[i][0] + cms[i][2]) / (cms[i][0] + cms[i][1] + cms[i][2] + cms[i][3])])
          }
          return conf_accs;
      }
      function cms_to_fpr_tprs(cms) {
          var fpr_tprs = [];
          var i, fpr, tpr;
          var p = confs.pos_confs.length;
          var n = confs.neg_confs.length;
          for (i = 0; i < cms.length; i++) {
              fpr = cms[i][1] / n; // FP / N
              tpr = cms[i][0] / p; // TP / P
              fpr_tprs.push([fpr, tpr, cms[i][4]]);
          }
          return fpr_tprs;
      }
      function to_google_data(pts, labels, tooltip) {
          var i;
          var data = new google.visualization.DataTable();
          for (i = 0; i < labels.length; i++) {
              data.addColumn('number', labels[i]);
          }
          if (tooltip) {
              data.addColumn({type: 'number', role: 'tooltip'});
          }
          data.addRows(pts);
          return data;
      }
      function plot_confs(confs) {
          var test_out = test_confs_to_confusion_matrix();
          if (test_out)
              alert(test_out);
          var data0 = to_google_data(confs_to_conf_hist(confs.pos_confs, confs.neg_confs, 100), ['Confidence', '+', '-']);
          var options = {title: 'Classifier Confidence',
                         hAxis: {title: 'Confidence'}};
          var chart0 = new google.visualization.LineChart(document.getElementById('graph_confidence_scatter'));
          chart0.draw(data0, options);

          var data1 = to_google_data(confs_to_conf_hist(confs.pos_confs, confs.neg_confs, 100, true), ['Confidence', '+', '-']);
          options = {title: 'Classifier Confidence (normalized)',
                     hAxis: {title: 'Confidence'}};
          var chart1 = new google.visualization.LineChart(document.getElementById('graph_confidence_scatter_norm'));
          chart1.draw(data1, options);

          // PR Curve
          var cms = confs_to_confusion_matrix(confs.pos_confs, confs.neg_confs);
          // Confidence accuracy
          var data4 = to_google_data(cms_to_conf_accs(cms), ['Confidence', 'Accuracy']);
          options = {title: 'Classifier Confidence vs Accuracy',
                     hAxis: {title: 'Confidence'}};
          var chart4 = new google.visualization.LineChart(document.getElementById('graph_confidence_accuracy'));
          chart4.draw(data4, options);
          var data2 = to_google_data(cms_to_rps(cms), ['recall', 'precision'], true);
          options = {title: 'PR Curve',
                     hAxis: {title: 'Recall', minValue: 0, maxValue: 1},
                     vAxis: {title: 'Precision', minValue: 0, maxValue: 1},
                     chartArea: {width: 200, height: 200},
                     legend: {position: 'none'}};
          var chart2 = new google.visualization.LineChart(document.getElementById('graph_rps'));
          chart2.draw(data2, options);

          var data3 = to_google_data(cms_to_fpr_tprs(cms), ['fpr', 'tpr'], true);
          options = {title: 'ROC Curve',
                     hAxis: {title: 'FPR', minValue: 0, maxValue: 1},
                     vAxis: {title: 'TPR', minValue: 0, maxValue: 1},
                     chartArea: {width: 200, height: 200},
                     legend: {position: 'none'}};
          var chart3 = new google.visualization.LineChart(document.getElementById('graph_roc'));
          chart3.draw(data3, options);

          
          // This connects all the charts together
          function setNearest(chart, data, column, select_columns, val) {
              var i, minVal = Infinity, minIndex, curVal;
              for (i = 0; i < data.getNumberOfRows(); i++) {
                  curVal = Math.abs(val - data.getValue(i, column));
                  if (curVal < minVal) {
                      minVal = curVal;
                      minIndex = i;
                  }
              }
                              
              chart.setSelection(_.map(select_columns, function (col) {return {row: minIndex, column: col}}));
          }
          function setSelections(thresh) {
              setNearest(chart0, data0, 0, [1, 2], thresh);
              setNearest(chart1, data1, 0, [1, 2], thresh);
              setNearest(chart2, data2, 2, [1], thresh);
              setNearest(chart3, data3, 2, [1], thresh);
              setNearest(chart4, data4, 0, [1], thresh);
          }
          var al = google.visualization.events.addListener;
          al(chart0, 'select', function () {var sel = chart0.getSelection(); if (sel[0] !== undefined) setSelections(data0.getValue(sel[0].row, 0))});
          al(chart1, 'select', function () {var sel = chart1.getSelection(); if (sel[0] !== undefined) setSelections(data1.getValue(sel[0].row, 0))});
          al(chart2, 'select', function () {var sel = chart2.getSelection(); if (sel[0] !== undefined) setSelections(data2.getValue(sel[0].row, 2))});
          al(chart3, 'select', function () {var sel = chart3.getSelection(); if (sel[0] !== undefined) setSelections(data3.getValue(sel[0].row, 2))});
          al(chart4, 'select', function () {var sel = chart4.getSelection(); if (sel[0] !== undefined) setSelections(data4.getValue(sel[0].row, 0))});
      }
    </script>


    <script type="text/html" id="tpl_index_compute">
      <div>
        <select id="model_select"></select>
      <input class="input-small" type="text" placeholder="Index Key" id="modelKey" value="" readonly="readonly">
        <input type="file" id="imagefile" class="input-small">
      </div>
      <div id="results"></div>
    </script>
    
    <script type="text/javascript">
      function load_image(table, row, imageColumn, id) {
          function success_img_func(xhr) {
              var response = JSON.parse(xhr.responseText);
              $('#' + id).attr('src', 'data:image/jpeg;base64,' + response[imageColumn]);
          }
          picarus_api_row(table, row, "GET", {data: {column: imageColumn}, success: success_img_func});
      }
      function render_index_compute() {
          model_dropdown({modelFilter: function (x) {return x.get('prefix') === 'srch:'},
                          change: function() {
                              var row = this.$el.find(":selected").val();
                              m = this.collection.get(row);
                              $('#modelKey').val(row);
                          },
                          el: $('#model_select')});
          $('#imagefile').change(function () {
              if ($('#imagefile')[0].files.length != 1) {
                  display_alert('You must specify an image!');
                  return;
              }
              var imageColumn = encode_id('data:image')
              var thumbColumn = encode_id('thum:image_150sq')
              var modelKey = $('#modelKey').val();
              function success_func(xhr) {
                  resp = JSON.parse(xhr.responseText);
                  $.each(resp, function (x, y) {
                      var cur_id = 'result_' + x;
                      $('#results').append($('<img>').attr('id', cur_id));
                      $('#results').append(y[0]);
                      $('#results').append($('<br>'));
                      load_image(table, y[1], thumbColumn, cur_id)
                      /*function success_img_func(xhr) {
                          var response = JSON.parse(xhr.responseText);
                          $('#' + cur_id).attr('width', '150px').attr('src', 'data:image/jpeg;base64,' + response[thumbColumn]);
                      }
                      picarus_api_row(table, y[1], "GET", {data: {imageColumn: thumbColumn}, success: success_img_func}); */
                  });
              }
              function upload_func(xhr) {
                  var response = JSON.parse(xhr.responseText);
                  picarus_api_row(table, response.row, "POST", {data: {imageColumn: imageColumn, action: 'i/search', model: modelKey}, success: success_func})
              }
              var table = 'images';
              var data = {};
              data[imageColumn] = $('#imagefile')[0].files[0];
              picarus_api_upload(table, {data: data, success: upload_func})
          })
      }
    </script>


    <script type="text/html" id="tpl_index_evaluate">
      <%=rowSelect%>
    </script>

    <script type="text/javascript">
      function render_index_evaluate() {
          row_selector();
      }
    </script>

    <script type="text/html" id="tpl_visualize_thumbnails">
      <%=rowSelect%>
      <%=filter%>
      <button class="btn" type="submit" id="runButton" style="margin-bottom: 9px">Run</button>
      <div id="results"></div>
    </script>

    <script type="text/javascript">
      function render_visualize_thumbnails() {
          row_selector();
          $('#runButton').click(function () {
              var startRow = encode_id(unescape($('#startRow').val()));
              var stopRow = encode_id(unescape($('#stopRow').val()));
              var imageColumn = encode_id('thum:image_150sq');
              var metaCF = encode_id('meta:');
              if (startRow.length == 0 || stopRow.length == 0) {
                  display_alert('Must specify rows');
                  return;
              }
              $('#results').html('');
              function success(row, columns) {
                  $('#results').append($('<img>').attr('src', 'data:image/jpeg;base64,' + columns[imageColumn]))
                  //$('#results').append($('<br>'));
              }
              var params = {success: success, maxRows: 100};
              var filter = unescape($('#filter').val());
              if (filter.length > 0) {
                  params.filter = filter;
              }
              picarus_api_data_scanner("images", startRow, stopRow, [imageColumn, metaCF], params)
          });
      }
    </script>


    <script type="text/html" id="tpl_visualize_metadata">
      <%=rowSelect%>
      <%=filter%>
      <input class="input-small" type="text" placeholder="Max Size" id="maxSize" value="128">
      <button class="btn" type="submit" id="runButton" style="margin-bottom: 9px">Run</button>
      <button class="btn" type="submit" id="removeButton" style="margin-bottom: 9px" disabled>Remove</button>
      <div id="results"></div>
    </script>

    <script type="text/javascript">
      function render_visualize_metadata() {
          row_selector();
          $('#runButton').click(function () {
              var startRow = encode_id(unescape($('#startRow').val()));
              var stopRow = encode_id(unescape($('#stopRow').val()));
              var max_size = Number($('#maxSize').val());
              var metaCF = encode_id('meta:');
              if (startRow.length == 0 || stopRow.length == 0) {
                  display_alert('Must specify rows');
                  return;
              }
              button_confirm_click_reset($('#removeButton'));
              // Setup table
              images = new PicarusImages();
              function remove_rows() {
                 // TODO: Since there is a maxRows setting, this won't remove all rows, just the ones we have available
                 var rows = _.map(images.models, function (x) {return x.id})
                 picarus_api_delete_rows(rows, {done: function () {alert('Done removing rows')}});
              }
              function done() {
                  $('#results').html('');
                  if (!images.length)
                      return;
                  var AppView = Backbone.View.extend({
                      initialize: function() {
                          _.bindAll(this, 'render');
                          this.collection.bind('reset', this.render);
                          this.collection.bind('change', this.render);
                          this.collection.bind('add', this.render);
                      },
                      render: function() {
                          var columns = _.uniq(_.flatten(_.map(this.collection.models, function (x) {
                              return _.keys(x.attributes);
                          })));
                                  picarus_table = new Backbone.Table({
                                  collection: this.collection,
                                  columns: _.map(columns, function (v) {
                                          if (v === "row")
                                              return [v, v];
                                          return {header: base64.decode(v), getFormatted: function() {
                                              var out = this.get(v);
                                              if (typeof out !== 'undefined') {
                                                  out = base64.decode(out);
                                                  if (out.length <= max_size)
                                                      return out;
                                                  else
                                                      return '<span style="color:red">' + out.slice(0, max_size) + '</span>'
                                              }
                                          }};
                                      })
                                  });
                                  this.$el.html(picarus_table.render().el);
                              }
                  });
                  av = new AppView({collection: images, el: $('#results')});
                  av.render();
                  $('#removeButton').removeAttr('disabled');
                  button_confirm_click($('#removeButton'), remove_rows);
              }
              function success(row, columns) {
                  c=columns;
                  columns.row = row;
                  images.add(columns);
              }
              var params = {success: success, maxRows: 1000, done: done};
              var filter = unescape($('#filter').val());
              if (filter.length > 0) {
                  params.filter = filter;
              }
              picarus_api_data_scanner("images", startRow, stopRow, [metaCF], params)
          });
      }
    </script>

    <script type="text/html" id="tpl_visualize_exif">
      <%=rowSelect%>
      <%=filter%>
      <input class="input-small" type="text" placeholder="Max Size" id="maxSize" value="128">
      <button class="btn" type="submit" id="runButton" style="margin-bottom: 9px">Run</button>
      <button class="btn" type="submit" id="removeButton" style="margin-bottom: 9px" disabled>Remove</button>
      <div id="results"></div>
    </script>

    <script type="text/javascript">
      function render_visualize_exif() {
          row_selector();
          // TODO: Fix for exif
          $('#runButton').click(function () {
              var startRow = encode_id(unescape($('#startRow').val()));
              var stopRow = encode_id(unescape($('#stopRow').val()));
              var max_size = Number($('#maxSize').val());
              var metaCF = encode_id('meta:');
              if (startRow.length == 0 || stopRow.length == 0) {
                  display_alert('Must specify rows');
                  return;
              }
              button_confirm_click_reset($('#removeButton'));
              // Setup table
              images = new PicarusImages();
              var exif_column = base64.encode('meta:exif');
              function remove_rows() {
                 // TODO: Since there is a maxRows setting, this won't remove all rows, just the ones we have available
                 var rows = _.map(images.models, function (x) {return x.id})
                 picarus_api_delete_rows(rows, {done: function () {alert('Done removing rows')}});
              }
              function done() {
                  $('#results').html('');
                  if (!images.length)
                      return;
                  var AppView = Backbone.View.extend({
                      initialize: function() {
                          _.bindAll(this, 'render');
                          this.collection.bind('reset', this.render);
                          this.collection.bind('change', this.render);
                          this.collection.bind('add', this.render);
                      },
                      render: function() {
                          var cur_images = this.collection.filter(function (x) {return x.get(exif_column) != 'e30='});
                          columns = _.uniq(_.flatten(_.map(cur_images, function (x) {
                              return _.keys(JSON.parse(base64.decode(x.get(exif_column))));
                          }))).concat(['row']);
                                  picarus_table = new Backbone.Table({
                                  collection: this.collection,
                                  columns: _.map(columns, function (v) {
                                          if (v === "row")
                                              return [v, v];
                                          return {header: v, getFormatted: function() {
                                              var cur_exif = JSON.parse(base64.decode(this.get(exif_column)));
                                              var out = cur_exif[v];
                                              if (typeof out !== 'undefined') {
                                                  if (!_.isString(out))
                                                      return _.escape(JSON.stringify(out));
                                                  out = base64.decode(out);
                                                  if (typeof out.length <= max_size)
                                                      return _.escape(out);
                                                  else
                                                      return '<span style="color:red">' + _.escape(out.slice(0, max_size)) + '</span>'
                                              }
                                          }};
                                      })
                                  });
                                  this.$el.html(picarus_table.render().el);
                              }
                  });
                  av = new AppView({collection: images, el: $('#results')});
                  av.render();
                  $('#removeButton').removeAttr('disabled');
                  button_confirm_click($('#removeButton'), remove_rows);
              }
              function success(row, columns) {
                  c=columns;
                  columns.row = row;
                  if (columns[exif_column] != 'e30=')
                      images.add(columns);
              }
              var params = {success: success, maxRows: 1000, done: done};
              var filter = unescape($('#filter').val());
              if (filter.length > 0) {
                  params.filter = filter;
              }
              picarus_api_data_scanner("images", startRow, stopRow, [metaCF], params)
          });
      }
    </script>

    <script type="text/html" id="tpl_visualize_duplicates">
      <%=rowSelect%>
      <button class="btn" type="submit" id="runButton" style="margin-bottom: 9px">Run</button>
      <button class="btn" type="submit" id="nextButton" style="margin-bottom: 9px" disabled>Next</button>
      <button class="btn" type="submit" id="removeButton" style="margin-bottom: 9px" disabled>Remove</button>
      <div id="results"></div>
      <div id="clusters"></div>
    </script>

    <script type="text/javascript">
      function button_confirm_click(button, fun) {
          button.unbind();
          button.click(function () {
              button.unbind();
              button.addClass('btn-danger');
              button.click(fun);
          });
      }
      function button_confirm_click_reset(button) {
          button.removeClass('btn-danger');
      }
      function render_visualize_duplicates() {
          row_selector();
          $('#runButton').click(function () {
              var startRow = encode_id(unescape($('#startRow').val()));
              var stopRow = encode_id(unescape($('#stopRow').val()));
              var imageColumn = encode_id('data:image');
              var thumbColumn = encode_id('thum:image_150sq');
              if (startRow.length == 0 || stopRow.length == 0) {
                  display_alert('Must specify rows');
                  return;
              }
              button_confirm_click_reset($('#removeButton'));
              alert_running();
              function display_clusters (clusters) {
                  var num = 30;
                  var next_clusters = clusters.slice(num);
                  var cur_clusters = clusters.slice(0, num);
                  var el = $('#clusters');
                  el.empty();
                  $('#nextButton').unbind();
                  if (next_clusters.length) {
                      $('#nextButton').removeAttr('disabled');
                      $('#nextButton').click(function () {display_clusters(next_clusters)});
                  } else {
                      $('#nextButton').attr('disabled', '');
                  }
                  _.each(cur_clusters, function (x) {
                      _.each(x.rows, function (y) {
                          var cur_id = _.uniqueId('image_');
                          el.append($('<img>').attr('id', cur_id));
                          load_image('images', y, thumbColumn, cur_id);
                      })
                      el.append($('<br>'));
                  });
              }
              function remove_dupes(clusters) {
                 var rows = [];
                 _.each(clusters, function (x) {rows = rows.concat(_.shuffle(x.rows).slice(1));console.log(rows.length)});
                 picarus_api_delete_rows(rows, {done: function () {alert('Done removing duplicates')}});
              }
              function success_func(xhr) {
                  alert_done();
                  var dedupe_response = JSON.parse(xhr.responseText);
                  $('#removeButton').removeAttr('disabled');
                  button_confirm_click($('#removeButton'), function () {remove_dupes(dedupe_response)})
                  display_clusters(dedupe_response);
                  /*
                  PicarusImageCluster = Backbone.Model.extend({});
                  PicarusImageClusters = Backbone.Collection.extend({model: PicarusImageCluster});
                  clusters = new PicarusImageClusters();
                  var AppView = Backbone.View.extend({
                      initialize: function() {
                          _.bindAll(this, 'render');
                          this.collection.bind('reset', this.render);
                          this.collection.bind('change', this.render);
                      },
                      render: function() {
                                  this.$el.empty();

                              }
                  });
                  new AppView({collection: clusters, el: $('#clusters')});
                  clusters.reset(dedupe_response);
                 */
              }
              picarus_api("/a1/slice/images/" + startRow + '/' + stopRow, "POST", {success: success_func, data: {action: 'i/dedupe/identical', column: imageColumn}});
          });
      }
    </script>

    <script type="text/html" id="tpl_visualize_locations">
      <%=rowSelect%>
      <%=filter%>
      <input class="input-small" type="text" placeholder="Target Latitude" id="demolat" value="38.8811">
      <input class="input-small" type="text" placeholder="Target Longitude" id="demolong" value="-77.0369">
      <input class="input-small" type="text" placeholder="Max Distance" id="demodist" value="5">
      <input class="input-small" type="checkbox" id="filterInvert">
      <button class="btn" type="submit" id="runButton" style="margin-bottom: 9px">Run</button>
      <button class="btn" type="submit" id="removeButton" style="margin-bottom: 9px" disabled>Remove</button>
      <div id="map_canvas" style="width:100%; height:500px"></div>
    </script>

    <script type="text/javascript">
      function deg2rad(deg) {
          return deg * (Math.PI/180)
      }
      function getDistanceFromLatLonInKm(lat1,lon1,lat2,lon2) {
         // From: http://stackoverflow.com/questions/27928/how-do-i-calculate-distance-between-two-latitude-longitude-points
         var R = 6371; // Radius of the earth in km
         var dLat = deg2rad(lat2-lat1);
         var dLon = deg2rad(lon2-lon1); 
         var a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2); 
         var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
         var d = R * c; // Distance in km
         return d;
      }
      function filter_lat_long(lat, long) {
          var targetLat = Number($('#demolat').val());
          var targetLong = Number($('#demolong').val());
          var targetDist = Number($('#demodist').val());
          var checked = $('#filterInvert').is(':checked');
          if (getDistanceFromLatLonInKm(targetLat, targetLong, lat, long) > targetDist)
              return !checked;
          return checked;
      }
      function render_visualize_locations() {
          row_selector();
          $('#runButton').click(function () {
              var latitude = encode_id('meta:latitude');
              var longitude = encode_id('meta:longitude');
              button_confirm_click_reset($('#removeButton'));
              images = new PicarusImages();
              function maps_success(row, columns) {
                  columns.row = row;
                  var curLat = base64.decode(columns[latitude]);
                  var curLong = base64.decode(columns[longitude]);
                  if (filter_lat_long(Number(curLat), Number(curLong))) {
                      return;
                  }
                  images.add(new PicarusImage(columns));
              }
              function maps_done() {
                  var centerLat = Number($('#demolat').val());
                  var centerLong = Number($('#demolong').val());
                  button_confirm_click($('#removeButton'), function () {
                      var rows = _.map(images.models, function (x) {return x.get('row')});
                      picarus_api_delete_rows(rows, {done: function () {alert('Done removing rows')}});
                  });
                  $('#removeButton').removeAttr('disabled');
                  if (!centerLat || !centerLat) {
                      centerLat = Number(base64.decode(images.at(0).get(latitude)));
                      centerLong = Number(base64.decode(images.at(0).get(longitude)));
                  }
                  var mapOptions = {
                      zoom: 14,
                      center: new google.maps.LatLng(centerLat, centerLong),
                      mapTypeId: google.maps.MapTypeId.HYBRID
                  };
                   map = new google.maps.Map(document.getElementById("map_canvas"),
                      mapOptions);
                  google.maps.event.addListener(map, 'rightclick', function(event){
                      $('#demolat').val(event.latLng.lat());
                      $('#demolong').val(event.latLng.lng());
                  });
                  images.each(function (x) {
                      var lat = Number(base64.decode(x.get(latitude)));
                      var long = Number(base64.decode(x.get(longitude)));
                      new google.maps.Marker({position: new google.maps.LatLng(lat, long), map: map});
                  });
              }
              picarus_api_data_scanner("images", encode_id(unescape($('#startRow').val())), encode_id(unescape($('#stopRow').val())), [latitude, longitude], {success: maps_success, done: maps_done});
          })
      }
    </script>

    <script type="text/html" id="tpl_visualize_times">
      <%=rowSelect%>
      <button class="btn" type="submit" id="runButton" style="margin-bottom: 9px">Run</button>
      <div id="histYear"></div>
      <div id="histMonth"></div>
      <div id="histHour"></div>
      <div id="histDay"></div>
    </script>

    <script type="text/javascript">
      function render_visualize_times() {
          row_selector();
          function drawYears(hist) {
              var data = google.visualization.arrayToDataTable([['Year', 'Count']].concat(hist));
              new google.visualization.ColumnChart(document.getElementById('histYear')).draw(data, {title:"Histogram (Year)", width:600, height:400, vAxis: {title: "Count"}, hAxis: {title: "Year"}});
          }
          function drawMonths(hist) {
              var data = google.visualization.arrayToDataTable([['Month', 'Count']].concat(hist));
              new google.visualization.ColumnChart(document.getElementById('histMonth')).draw(data, {title:"Histogram (Month)", width:600, height:400, vAxis: {title: "Count"}, hAxis: {title: "Month"}});
          }
          function drawHours(hist) {
              var data = google.visualization.arrayToDataTable([['Hour', 'Count']].concat(hist));
              new google.visualization.ColumnChart(document.getElementById('histHour')).draw(data, {title:"Histogram (Hour)", width:600, height:400, vAxis: {title: "Count"}, hAxis: {title: "Hour"}});
          }
          function drawDays(hist) {
              var data = google.visualization.arrayToDataTable([['Day', 'Count']].concat(hist));
              new google.visualization.ColumnChart(document.getElementById('histDay')).draw(data, {title:"Histogram (Day)", width:600, height:400, vAxis: {title: "Count"}, hAxis: {title: "Day"}});
          }
      function dataToHist(data) {
          var hist = {};
          _.each(data, function (x) {
              var y = 0;
              if (_.has(hist, x)) {
                  y = hist[x];
              }
              hist[x] = y + 1;
          });
          return hist;
      }
      function dataToListHist(data) {
          return _.pairs(dataToHist(data)).sort();
      }
          $('#runButton').click(function () {
          var timeColumn = encode_id('meta:dateupload');
              images = new PicarusImages();
              function time_success(row, columns) {
                  columns.row = row;
                  images.add(new PicarusImage(columns));
              }
              function time_done() {
                  years = [];
                  months = [];
                  hours = [];
                  days = [];
                  // TODO: FInish visual
                  images.each(function (x) {
                      var curTime = Number(base64.decode(x.get(timeColumn)));
                      var curDate = new Date(0);
                      curDate.setUTCSeconds(curTime);
                      years.push(curDate.getFullYear());
                      months.push(curDate.getMonth());
                      hours.push(curDate.getHours());
                      days.push(curDate.getDay());
                  });
                  drawYears(dataToListHist(years));
                  drawMonths(dataToListHist(months));
                  drawHours(dataToListHist(hours));
                  drawDays(dataToListHist(days));
              }
          picarus_api_data_scanner("images", encode_id(unescape($('#startRow').val())), encode_id(unescape($('#stopRow').val())), [timeColumn], {success: time_success, done: time_done});
      })
      }
    </script>

    <script type="text/html" id="tpl_admin_users">
      <div id="users"></div>
    </script>

    <script type="text/javascript">
      function render_admin_users() {
          users = new PicarusUsers();
          var AppView = Backbone.View.extend({
              initialize: function() {
                  _.bindAll(this, 'render');
                  this.collection.bind('reset', this.render);
                  this.collection.bind('change', this.render);
              },
              render: function() {
                          picarus_table = new Backbone.Table({
                          collection: this.collection,
                          columns: [["email", "Email"],
                                    ["uploadRowPrefix", "Row Prefix"],
                                    {header: "Prefixes", getFormatted: function() { return _.escape(JSON.stringify(this.get('imagePrefixes')))}}]
                          });
                          this.$el.html(picarus_table.render().el);
                      }
          });
          new AppView({collection: users, el: $('#users')});
          users.fetch();
      }
    </script>

    <script type="text/html" id="tpl_docs_filters">
      <h3>Only output rows where column meta:class is exactly equal to 'dinner'</h3>
      <pre>SingleColumnValueFilter ('meta', 'class', =, 'binary:dinner')</pre>
    </script>

    <script type="text/html" id="tpl_docs_api">
      <h2>REST /:version/data/ calls</h2>
      <pre>
        Supported
        create â†’ POST /:table
        read â†’ GET /:table
        read â†’ GET /data/:table/:row
        update â†’ PATCH /:table/:row
        delete â†’ DELETE /:table/row
        delete â†’ DELETE /:table/:row/:column

        Planned
        update â†’ PUT /:row (common semantics suggest this includes ALL data, which may be very large for images)
      </pre>

      <h2>REST /:version/slice/ calls</h2>
      <pre>
        Supported
        read â†’ GET /:startRow/:stopRow

        Planned
        delete â†’ GET /:startRow/:stopRow
        delete â†’ GET /:startRow/:stopRow/:column
      </pre>
    </script>

    </div>


    <div class="navbar navbar-inverse navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
          <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </a>
          <a class="brand" href="">api.picar.us</a>
          <div class="nav-collapse collapse">
            <!-- NAV BAR ITEM AREA -->
            <ul id="nav-item-container" class="nav"></ul>
          </div>
        </div>
      </div>
    </div>
    <div id="authModal" class="modal hide fade" data-keyboard="false" tabindex="-1" role="dialog" aria-labelledby="authModalLabel" aria-hidden="true">
      <div class="modal-header">
        <h3>Authenticate</h3>
      </div>
      <div class="modal-body">
        <div class="well control-group" id="secondFactorAuth">
          <input class="input-xlarge" type="password" placeholder="Yubikey" id="otp" value="" disabled> <div style="padding-bottom: 5px">OR</div> <input class="input-large" type="password" placeholder="API Key" id="apiKey" value=""disabled><button class="btn" type="submit" id="emailKeys" style="margin-bottom: 9px" disabled>Email Key</button>
        </div>
        <div style="padding-bottom: 10px">
          AND
        </div>
        <div  class="well">
          <input class="input-large" type="text" placeholder="Email" id="email" value=""><span class="help-inline">Email</span>
          <input class="input-large" type="password" placeholder="Login Key" id="loginKey" value=""><span class="help-inline">Login Key</span>
        </div>
      </div>
    </div>
    <div id="container" class="container"></div>
    <script type="text/javascript">
      $(document).ready(app_main);
      google.load("visualization", "1", {packages:["corechart"]});
    </script>
  </body>
</html>

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>api.picar.us</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="Brandyn A. White">
    <link rel="icon" href="/static/favicon.ico" type="image/x-icon">

    <!-- Le styles -->
    <!-- <link href="/static/bootstrap.min.css" rel="stylesheet">-->

    <link href="/static/bootstrap_flat.css" rel="stylesheet">
    <link href="/static/flat-ui.css" rel="stylesheet">
    <link href="/static/hint.min.css" rel="stylesheet">
    <script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.4.4/underscore-min.js"></script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/backbone.js/0.9.10/backbone-min.js"></script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/mustache.js/0.7.0/mustache.min.js"></script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.3.1/jquery.cookie.min.js"></script>
    <script type="text/javascript" src="//www.google.com/jsapi"></script>
    <script type="text/javascript" src="/static/base64.js"></script>
    <script type="text/javascript" src="/static/bootstrap.min.js"></script>
    <script type="text/javascript" src="/static/encodings.js"></script>
    <script type="text/javascript" src="/static/picarus_api.js"></script>
    <script type="text/javascript" src="/static/app.js"></script>
    <script type="text/javascript" src="/static/backbone.table.js"></script>
    <script type="text/javascript" src="/static/custom_checkbox_and_radio.js"></script>
    <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBBsKtzgLTIsaoxAFUvSNoJ8n3j4w9VZs0&sensor=false"></script>
    <style>
      // Models Table
      table { margin: 10px; font-family: Georgia, serif }
      thead, tfoot { background: #D8E2EB; }
      tr.even { background: #F2F4F5; }
      th { font-weight: bold; }
      th, td { padding: 5px 10px; }
      th+th, td+td { border-left: 1px solid #FFF; }
      .skinny {border: 0px; padding: 0px; margin: 0px}

    </style>

    <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le fav and touch icons -->
    <link rel="shortcut icon" href="../assets/ico/favicon.ico">
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="../assets/ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../assets/ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../assets/ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="../assets/ico/apple-touch-icon-57-precomposed.png">
  </head>

  <body>
    <div id="tpls">
    <script type="text/html" id="bpl_login">
      <input class="input-small" type="text" placeholder="Email" id="userEmail" value="">
      <input class="input-small" type="password" placeholder="Auth" id="userAuth" value="">
      <input class="input-small" type="checkbox" id="userSave">
    </script>

    <script type="text/html" id="bpl_login_hidden">
      <input type="hidden" id="userEmail" value="">
      <input type="hidden" id="userAuth" value="">
    </script>

    <script type="text/html" id="bpl_row_select">
          <h3>Slice</h3>
          <select id="rowPrefixDrop" class="input-small"></select>
          <span class="hint hint--bottom" data-hint="Start row (inclusive, percent encode binary)"><input class="input-small" type="text" placeholder="Row start" id="startRow"></span>
          <span class="hint hint--bottom" data-hint="Stop row (exclusive, percent encode binary)"><input class="input-small" type="text" placeholder="Row stop" id="stopRow"></span>
    </script>

    <script type="text/html" id="bpl_filter">
      <span class="hint hint--bottom" data-hint="Filter (see Docs/Filters)"><input class="input-large" type="text" placeholder="Filter" id="filter" value=""></span>
    </script>

    <script type="text/html" id="bpl_prefix_select">
          <h3>Prefix</h3>
          <select id="rowPrefixDrop"></select>
    </script>


    <script type="text/html" id="tpl_data_prefixes">
      <div class="span12 well" style="padding: 0px; margin: 0px; border: 0px">
        <div class="span8">
          <h3>Actions</h3>
          <select id="prefixTable" class="input-small" hint="Table for the new prefix">
          </select>
          <select id="prefixDrop" class="input-medium" hint="Base prefix">
          </select>
          <input class="input-small" type="text" placeholder="Prefix" hint="Suffix to add" id="suffix" value="">
          <select id="permissions" class="input-mini" hint="Permissions for new prefix">
          </select>
          <button class="btn" type="submit" id="createButton" style="margin-bottom: 9px">Create Prefix</button>
        </div>
      </div>
      <div id="prefixes"></div>
    </script>

    <script type="text/javascript">
      function render_data_prefixes() {
          rows = new PicarusRows([], {'table': 'prefixes'});
          function prefixChange() {
              var row = $('#prefixTable option:selected').val();
              var permissions = rows.get(row).pescape($('#prefixDrop option:selected').val());
              ps = permissions;
              var perms = ['r'];
              if (permissions == 'rw')
                  perms = ['rw', 'r'];
              var select_template = "{{#prefixes}}<option value='{{.}}'>{{.}}</option>{{/prefixes}};"
              $('#permissions').html(Mustache.render(select_template, {prefixes: perms}));
          }
          function change() {
              var row = $('#prefixTable option:selected').val();
              var prefixes = [];
              _.each(rows.get(row).attributes, function (val, key) {
                  if (key == 'row')
                      return;
                  prefixes.push(decode_id(key));
              });
              prefixes.sort();
              var select_template = "{{#prefixes}}<option value='{{.}}'>{{.}}</option>{{/prefixes}};"
              $('#prefixDrop').html(Mustache.render(select_template, {prefixes: prefixes}));
              $('#prefixDrop').change(prefixChange); // TODO: Redo this in backbone
              prefixChange();
          }
          rows_dropdown(rows, {el: $('#prefixTable'), text: function (x) {return x.pescaperow()}, change: change});
          $('#createButton').click(function () {
              var row = $('#prefixTable option:selected').val();
              var data = {}
              data[$('#prefixDrop option:selected').val() + $('#suffix').val()] = $('#permissions option:selected').val(); 
              rows.get(row).psave(data, {patch: true});        
          });
          var tableColumn = {header: "Table", getFormatted: function() {
              return _.escape(base64.decode(this.get('row')));
          }};
          new RowsView({collection: rows, el: $('#prefixes'), extraColumns: [tableColumn], deleteValues: true});
          rows.fetch();
      }
    </script>

    <script type="text/html" id="tpl_data_user">
      <div id="users"></div>
    </script>

    <script type="text/javascript">
      function render_data_user() {
          users = new PicarusUsers();
          var AppView = Backbone.View.extend({
              initialize: function() {
                  _.bindAll(this, 'render');
                  this.collection.bind('reset', this.render);
                  this.collection.bind('change', this.render);
              },
              render: function() {
                          var columns = _.uniq(_.flatten(_.map(this.collection.models, function (x) {
                              return _.keys(x.attributes);
                          })));
                          picarus_table = new Backbone.Table({
                          collection: this.collection,
                          columns: _.map(columns, function (x) {
                              if (x === 'row')
                                  return {header: 'email', getFormatted: function() { return _.escape(base64.decode(this.get(x)))}}
                              return {header: decode_id(x), getFormatted: function() { return _.escape(base64.decode(this.get(x)))}};
                          }),
                          });
                          this.$el.html(picarus_table.render().el);
                      }
          });
          new AppView({collection: users, el: $('#users')});
          login_get(function (email_auth) {
              var user = new PicarusUser({row: encode_id(email_auth.email)});
              users.add(user);
              user.fetch();
              
          });
      }
    </script>

<!--
    <script type="text/html" id="tpl_data_explore">
    </script>

    <script type="text/javascript">
    </script>
-->


    <script type="text/html" id="tpl_data_uploads">
      <div id="images" style="padding-left:20px; padding-right:20px"></div>
    </script> 


    <script type="text/javascript">
      function render_data_uploads(email_auth) {
          function success_user(xhr) {
              response = JSON.parse(xhr.responseText);

          }
          var AppView = Backbone.View.extend({
              el: $('#container'),
              initialize: function() {
                  _.bindAll(this, 'render');
                  this.model.bind('reset', this.render);
                  this.model.bind('change', this.render);
              },
              render: function() {
                  var startRow = _.unescape(this.model.pescape('upload_row_prefix'));
                  var imageColumn = encode_id('thum:image_150sq');
                  function success(row, columns) {
                      //$('#images').append(escape(decode_id(row)));
                      //$('#images').append($('<br>'));
                      $('#images').append($('<img>').attr('src', 'data:image/jpeg;base64,' + columns[imageColumn]).attr('width', '150px'));
                      //$('#images').append($('<br>'));
                  }
                  picarus_api_data_scanner("images", encode_id(startRow), encode_id(prefix_to_stop_row(startRow)), [imageColumn], {success: success, maxRows: 24});
              }
          });
          var model = new PicarusUser({row: encode_id(email_auth.email)});
          new AppView({ model: model });
          model.fetch();
          //picarus_api("/a1/data/users/" + encode_id(email_auth.email), "GET", {success: success_user});
       }
    </script>

<!--
    <script type="text/html" id="tpl_data_import">
    </script> 

    <script type="text/html" id="tpl_data_export">
    </script> 
   
    <script type="text/html" id="tpl_triage_categorize">
    </script>
 
    <script type="text/html" id="tpl_triage_summarize">
    </script>
 -->

    <script type="text/html" id="tpl_crawl_flickr">
      <div class="span12 well" style="padding: 0px; margin: 0px; border: 0px">
        <div class="span3">
          <%=prefixSelect%>
        </div>
        <div class="span8">
        <h3>Options</h3>
      <input class="input-small" type="text" placeholder="Iterations" hint="Crawl iterations" id="demoiters" value="1">
      <input class="input-large" type="text" placeholder="Class Name" hint="Class name (put in meta:class)" id="democlass" value="">
      <input class="input-large" type="text" placeholder="Query" hint="Query used for search (put in meta:query)" id="demoquery" value="">
      <input class="input-large" type="text" placeholder="Latitude" hint="Latitude (decimal)" id="demolat" value="">
      <input class="input-large" type="text" placeholder="Longitude" hint="Longitude (decimal)" id="demolon" value="">
      <label class="checkbox" style="margin-bottom: 0px;" hint="Geotagged images only" for="demogeo">
        <input type="checkbox" value="" id="demogeo"> Geotagged
      </label>
      <button class="btn" type="submit" id="runButton" style="margin-bottom: 9px">Run</button>
      </div>
      <div class="clearfix span12 skinny" id="results"></div>
      <div class="clearfix span12 skinny" id="numRows"></div>
        </div>
    </script>

    <script type="text/javascript">
      function render_crawl_flickr() {
      row_selector($('#rowPrefixDrop'), $('#startRow'), $('#stopRow'));
      $('#runButton').click(function () {
          var demo_class = $('#democlass').val();
          var demo_query = $('#demoquery').val();
          var row_prefix = $('#rowPrefixDrop').val();
          if (demo_class.length == 0 && row_prefix.length == 0) {
              display_alert('Must specify class and prefix');
              return;
          }
          var iters = parseInt($('#demoiters').val())
          var simul = 10;
          var done = 0;
          if (isNaN(iters) || iters < 1 || iters > 20) {
              display_alert('Iters must be 0 < x <= 20');
              return;
          }
          $('#numRows').html('');
          /* Check input */
          //reset_state();
          var min_time = 1232170610;
          var auth = {email: $('#demouser').val(), auth: $('#demopass').val()};
          var latitude = Number($('#demolat').val());
          var longitude = Number($('#demolon').val());
          function call_api() {
              if (iters <= 0) {
                  simul -= 1;
                  if (simul == 0)
                      alert_success_wrap($('#results'))();
                  return;
              }
              iters -= 1;
              var timeRadius = 60 * 60 * 24 * 30 * 6; // 6 months
              var minUploadDate = parseInt((new Date().getTime() / 1000 - min_time) * Math.random() + min_time - timeRadius);
              var maxUploadDate = parseInt(timeRadius + minUploadDate);
              var p = {hasGeo: Number($('#demogeo').is(':checked')), className: demo_class, className: demo_query, minUploadDate: minUploadDate, maxUploadDate: maxUploadDate, action: 'o/crawl/flickr'};
              if (latitude && longitude) {
                  p.lat = String(latitude);
                  p.lon = String(longitude);
              }
              function success(xhr) {
                  var response = JSON.parse(xhr.responseText);
                  function etod(e) {
                      var d = new Date(0);
                      d.setUTCSeconds(e);
                      return d.toString();
                  }
                  var data = {minUploadDate: etod(minUploadDate), maxUploadDate: etod(maxUploadDate), numRows: response.numRows};
                  $('#numRows').append('Crawl Finished : ' + JSON.stringify(data) + '<br>');
                  call_api();
              }
              picarus_api("/a1/slice/images/" + encode_id(row_prefix) + '/' + encode_id(prefix_to_stop_row(row_prefix)), "POST", {success: success, data: p});
          }
          alert_running_wrap($('#results'))();
          _.each(_.range(simul), call_api);
      });


      }
    </script>

    <script type="text/html" id="tpl_models_list">
      <div id="models"></div>
      <div id="myModal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
          <h3 id="myModalLabel" id="modal_header"></h3>
        </div>
        <div class="modal-body">
          <textarea id="modal_content" style="width: 100%; height: 100%; box-sizing: border-box;  resize: none; "></textarea>
        </div>
        <div class="modal-footer">
          <button class="btn" data-dismiss="modal" aria-hidden="true" id="close_button">Close</button>
          <button class="btn btn-primary" id="save_button">Save changes</button>
        </div>
      </div>
    <div id="container" class="container"></div>
    </script>
    
    <script type="text/javascript">
      function render_models_list() {
          models = new PicarusModels();
          var prefix_to_type = {'feat:': 'feature',
                                'mfeat:': 'multi_feature',
                                'mask:': 'mask_feature',
                                'pred:': 'classifier',
                                'srch:': 'index',
                                'hash:': 'hasher',
                                'data:': 'preprocessor'}
          var AppView = Backbone.View.extend({
              el: $('#container'),
              initialize: function() {
                  _.bindAll(this, 'render');
                  this.collection.bind('reset', this.render);
                  this.collection.bind('change', this.render);
                  this.collection.bind('remove', this.render);
              },
              render: function() {
                          picarus_table = new Backbone.Table({
                          collection: this.collection,
                          columns: [{header: "Name", className: "models-row", getFormatted: function() { return this.pescape('data:name')}},
                                    {header: "Notes", className: "models-notes", getFormatted: function() { return this.pescape('data:notes') + '<span style="font-size:5px"><a class="modal_link_notes" row="' + this.escape('row') + '">edit</a></span>'}},
                                    {header: "Tags", className: "models-tags", getFormatted: function() { return this.pescape('data:tags') + '<span style="font-size:5px"><a class="modal_link_tags" row="' + this.escape('row') + '">edit</a></span>'}},
                                    {header: "Prefix", getFormatted: function() { return this.pescape('data:prefix')}},
                                    {header: "Type", getFormatted: function() { return prefix_to_type[this.pescape('data:prefix')]}},
                                    {header: "Creation Time", getFormatted: function() { return this.pescape('data:creation_time')}},
                                    {header: "Row", className: "models-row", getFormatted: function() { return this.escape('row')}},
                                    {header: "Parameters", className: "models-params", getFormatted: function() { return this.pescape('data:param')}},
                                    {header: "Inputs", className: "models-inputs", getFormatted: function() { return this.pescape('data:input')}},
                                    {header: "Delete", className: "models-row", getFormatted: function() { return '<button class="btn row_delete" type="submit" row="' + this.escape('row') + '">Delete</button>'}}]
                          });
                          $("#models").html(picarus_table.render().el);
                          $('.modal_link_notes').click(function (data) {
                              var row = data.target.getAttribute('row');
                              var model = models.get(row);
                              $('#modal_content').val(model.pescape('data:notes'));
                              $('#save_button').unbind();
                              $('#save_button').click(function () {
                                  var attributes = {};
                                  attributes['data:notes'] = $('#modal_content').val();
                                  model.psave(attributes, {patch: true});
                                  $('#myModal').modal('hide');
                              });
                              $('#myModal').modal('show')
                          })
                          function delete_row(data) {
                              var row = data.target.getAttribute('row');
                              models.get(row).destroy({wait: true});
                          }
                          button_confirm_click($('.row_delete'), delete_row);
                          $('.modal_link_tags').click(function (data) {
                              var row = data.target.getAttribute('row');
                              var model = models.get(row);
                              $('#modal_content').val(model.pescape('data:tags'));
                              $('#save_button').unbind();
                              $('#save_button').click(function () {
                                  var attributes = {};
                                  attributes['data:tags'] = $('#modal_content').val();
                                  model.psave(attributes, {patch: true});
                                  $('#myModal').modal('hide')
                              });
                              $('#myModal').modal('show')
                          })
                      }
          });
          new AppView({ collection: models });
          models.fetch();
      }
    </script>

    <script type="text/html" id="tpl_models_create">
      <div class="span12 well" style="padding: 0px; margin: 0px; border: 0px">
        <div class="span11">
          <h3>Options</h3>
          <span id="selects">
            <select id="type_select" class="input-medium"></select>
            <select id="name_select" class="input-medium"></select>
            <span id="params"></span>
            <span id="row_select"></span>
          </span>
          <button class="btn" type="submit" id="runButton" style="margin-bottom: 9px">Run</button>
        </div>
      </div>
      <div class="clearfix span12 skinny" id="results"></div>
    </script>
    <script type="text/javascript">
      function add_hint(el, text) {
          el.wrap($('<span>').attr('class', 'hint hint--bottom').attr('data-hint', text));
      }
      function render_models_create() {
          models = new PicarusParamModels();
          var AppView = Backbone.View.extend({
              initialize: function() {
                  _.bindAll(this, 'renderType');
                  _.bindAll(this, 'renderName');
                  this.collection.bind('reset', this.renderType);
                  this.collection.bind('change', this.renderType);
                  this.collection.bind('add', this.renderType);
              },
              events: {'change #type_select': 'renderName',
                       'change #name_select': 'renderParam'},
              renderParam: function () {
                  $('#params').html('');
                  $('#row_select').html('');
                  var model_type = $('#type_select option:selected').val();
                  var name = $('#name_select option:selected').val();
                  //model = this.collection.where({type: model_type, name: name})[0];
                  model = models.filter(function (x) {
                      if (x.pescape('type') == model_type && x.pescape('name') == name)
                          return true;
                  })[0];

                  function add_param_selections(params, param_prefix) {
                      _.each(params, function (value, key) {
                          var cur_el;
                          if (value.type == 'enum') {
                              var select_template = "{{#models}}<option value='{{.}}'>{{.}}</option>{{/models}};"
                              cur_el = $('<select>').attr('name', param_prefix + key).html(Mustache.render(select_template, {models: value.values}));
                          } else if (value.type == 'int') {
                              // TODO: Client-side data validation
                              cur_el = $('<input>').attr('name', param_prefix + key).attr('type', 'text').addClass('input-medium');
                          } else if (value.type == 'str') {
                              // TODO: Client-side data validation
                              cur_el = $('<input>').attr('name', param_prefix + key).attr('type', 'text').addClass('input-medium');
                          }
                          if (typeof cur_el !== 'undefined') {
                              $('#params').append(cur_el);
                              add_hint(cur_el, key);
                          }
                      });
                  }
                  add_param_selections(model.pescapejs('model_params'), 'model-');
                  add_param_selections(model.pescapejs('module_params'), 'module-');
                  if (model.pescape('data') === 'slice') {
                      $('#row_select').append(document.getElementById('bpl_row_select').innerHTML);
                      row_selector($('#rowPrefixDrop'), $('#startRow'), $('#stopRow'));
                  }
                  _.each(model.pescapejs('inputs'), function (value) {
                      var cur_el;
                      // TODO: Finish model inputs, figure out how to take the values from here and integrate them in the response
                      if (value === 'processed_image') {
                          var cur_id = _.uniqueId('model_select_');
                          $('#params').append($('<select>').attr('id', cur_id).attr('name', 'key-' + value).addClass('input-medium'));
                          model_dropdown({modelFilter: function (x) {return x.pescape('data:prefix') === 'data:'},
                                          change: function() {},
                                          el: $('#' + cur_id)});
                      } else if (value === 'feature') {
                          var cur_id = _.uniqueId('model_select_');
                          $('#params').append($('<select>').attr('id', cur_id).attr('name', 'key-' + value).addClass('input-medium'));
                          model_dropdown({modelFilter: function (x) {return x.pescape('data:prefix') === 'feat:'},
                                          change: function() {},
                                          el: $('#' + cur_id)});
                      } else if (value === 'multi_feature') {
                          var cur_id = _.uniqueId('model_select_');
                          $('#params').append($('<select>').attr('id', cur_id).attr('name', 'key-' + value).addClass('input-medium'));
                          model_dropdown({modelFilter: function (x) {return x.pescape('data:prefix') === 'mfeat:'},
                                          change: function() {},
                                          el: $('#' + cur_id)});
                      } else if (value === 'hash') {
                          var cur_id = _.uniqueId('model_select_');
                          $('#params').append($('<select>').attr('id', cur_id).attr('name', 'key-' + value).addClass('input-medium'));
                          model_dropdown({modelFilter: function (x) {return x.pescape('data:prefix') === 'hash:'},
                                          change: function() {},
                                          el: $('#' + cur_id)});
                      } else if (value === 'raw_image') {
                          $('#params').append($('<input>').attr('name', 'key-' + value).attr('type', 'hidden').val(encode_id('data:image')));
                      } else if (value === 'meta') {
                          var cur_id = _.uniqueId('model_select_');
                          //
                          var el = $('<select>').attr('id', cur_id).attr('name', 'key-' + value).addClass('input-medium');
                          _.each(['meta:class', 'meta:class_0', 'meta:class_1', 'meta:class_2'], function (x) {
                              el.append($('<option>').attr('value', encode_id(x)).text(x))
                          });
                          $('#params').append(el);
                      }

                  });
              },
              renderName: function () {
                  var model_type = $('#type_select option:selected').val();
                  var cur_models = this.collection.filter(function (x) { return x.pescape('type') == model_type});
                  var select_template = "{{#models}}<option value='{{.}}'>{{.}}</option>{{/models}};"
                  var models_filt = _.map(cur_models, function (data) {return data.pescape('name')});
                  $('#name_select').html(Mustache.render(select_template, {models: models_filt}));
                  this.renderParam();
              },
              renderType: function() {
                  var select_template = "{{#models}}<option value='{{.}}'>{{.}}</option>{{/models}};"
                  var models_filt = _.uniq(_.map(this.collection.models, function (data) {return data.pescape('type')}));
                  $('#type_select').html(Mustache.render(select_template, {models: models_filt}));
                  this.renderName();
              }
         });
         av = new AppView({collection: models, el: $('#selects')});
         models.fetch();
         $('#runButton').click(function () {
             var params = _.object($('#params :input').map(function () {return [[$(this).attr('name'), $(this).val()]]}));
             function success(xhr) {
                 response = JSON.parse(xhr.responseText);
                 $('#results').html(response.row);
             }
             var model_type = $('#type_select option:selected').val();
             var name = $('#name_select option:selected').val();
             var model = models.filter(function (x) {
                    if (x.pescape('type') == model_type && x.pescape('name') == name)
                    return true;
             })[0];
             var path = model.get('row');
             if (model.pescape('data') === 'slice') {
                 var startRow = encode_id($('#startRow').val());
                 var stopRow = encode_id($('#stopRow').val());
                 params.action = 'i/train/' + path
                 picarus_api("/a1/slice/images/" + startRow + '/' + stopRow, "POST", {success: success, data: params});
             } else {
                 params.path = path
                 picarus_api("/a1/data/models", "POST", {success: success, data: params});
             }
         });
      }
    </script>

    <script type="text/html" id="tpl_process_thumbnail">
      <div class="span12 well" style="padding: 0px; margin: 0px; border: 0px">
        <div class="span5">
          <%=rowSelect%>
        </div>
        <div class="span5">
          <h3>Options</h3>
          <button class="btn" type="submit" id="runButton" style="margin-bottom: 9px">Run</button>
        </div>
      </div>
      <div class="clearfix span12 skinny" id="results"></div>
    </script>

    <script type="text/javascript">
      function render_process_thumbnail() {
          row_selector($('#rowPrefixDrop'), $('#startRow'), $('#stopRow'));
          $('#runButton').click(function () {
              alert_running_wrap($('#results'))();
              var startRow = encode_id($('#startRow').val());
              var stopRow = encode_id($('#stopRow').val());
              picarus_api("/a1/slice/images/" + startRow + '/' + stopRow, "POST", {success: alert_success_wrap($('#results')), fail: alert_fail_wrap($('#results')), data: {action: 'io/thumbnail'}});
          });
      }
    </script>

    <script type="text/html" id="tpl_process_exif">
      <div class="span12 well" style="padding: 0px; margin: 0px; border: 0px">
        <div class="span5">
          <%=rowSelect%>
        </div>
        <div class="span5">
          <h3>Options</h3>
          <button class="btn" type="submit" id="runButton" style="margin-bottom: 9px">Run</button>
        </div>
      </div>
      <div class="clearfix span12 skinny" id="results"></div>
    </script>

    <script type="text/javascript">
      function render_process_exif() {
          row_selector($('#rowPrefixDrop'), $('#startRow'), $('#stopRow'));
          $('#runButton').click(function () {
              alert_running();
              var startRow = encode_id($('#startRow').val());
              var stopRow = encode_id($('#stopRow').val());
              function success() {
                  alert_done();
              }
              picarus_api("/a1/slice/images/" + startRow + '/' + stopRow, "POST", {success: success, data: {action: 'io/exif'}});
          });
      }
    </script>

    <script type="text/html" id="tpl_process_modify">
      <div class="span12 well" style="padding: 0px; margin: 0px; border: 0px">
        <div class="span5">
          <%=rowSelect%>
        </div>
        <div class="span5">
          <h3>Options</h3>
          <input class="input-small" type="text" placeholder="Column" id="columnName" value="">
          <input class="input-small" type="text" placeholder="Value" id="columnValue" value="">
          <button class="btn" type="submit" id="runButton" style="margin-bottom: 9px">Run</button>
        </div>
      </div>
      <div class="clearfix span12 skinny" id="results"></div>
    </script>

    <script type="text/javascript">
      function render_process_modify() {
          row_selector($('#rowPrefixDrop'), $('#startRow'), $('#stopRow'));
          $('#runButton').click(function () {
              alert_running();
              var columnName = encode_id($('#columnName').val());
              var columnValue = base64.encode($('#columnValue').val());
              var startRow = encode_id($('#startRow').val());
              var stopRow = encode_id($('#stopRow').val());
              function success() {
                  alert_done();
              }
              var data = {};
              data[columnName] = columnValue;
              picarus_api("/a1/slice/images/" + startRow + '/' + stopRow, "PATCH", {success: success, data: data});
          });
      }
    </script>

    <script type="text/html" id="tpl_process_copy">
      <div class="span12 well" style="padding: 0px; margin: 0px; border: 0px">
        <div class="span5">
          <%=rowSelect%>
        </div>
        <div class="span3">
          <h3>Prefix</h3>
          <select id="rowPrefixDrop2"></select>
        </div>
        <div class="span5">
          <h3>Options</h3>
          <input class="input-small" type="text" placeholder="Column" id="columnName" value="">
          <input class="input-small" type="text" placeholder="Value" id="columnValue" value="">
          <input class="input-small" type="text" placeholder="Max Rows" id="maxRows" value="">
          <button class="btn" type="submit" id="runButton" style="margin-bottom: 9px">Run</div>
        </div>
      </div>
      <div class="clearfix span12 skinny" id="results"></div>
    </script>

    <script type="text/javascript">
      function random_bytes(num) {
          return _.map(_.range(10), function () {
              return String.fromCharCode(_.random(255));
          }).join('');
      }
      function render_process_copy() {
          row_selector($('#rowPrefixDrop'), $('#startRow'), $('#stopRow'));
          row_selector($('#rowPrefixDrop2'));
          $('#runButton').click(function () {
              alert_running();
              var imageColumn = encode_id('data:image');
              var columnName = encode_id($('#columnName').val());
              var columnValue = $('#columnValue').val();
              var startRow = encode_id($('#startRow').val());
              var stopRow = encode_id($('#stopRow').val());
              var prefix = $('#rowPrefixDrop2 option:selected').val();
              var maxRows = Number($('#maxRows').val());
              function success(row, columns) {
                  // Generate row key
                  var cur_row = encode_id(prefix + random_bytes(10));
                  cur_data = {};
                  cur_data[imageColumn] = columns[imageColumn];
                  console.log(cur_row);
                  console.log(columns[imageColumn].length);
                  if (columnName.length)
                      cur_data[columnName] = base64.encode(columnValue);
                  picarus_api_row("images", cur_row, "PATCH", {data: cur_data});
              }
              // Scan through rows, each one write back to the prefix
              picarus_api_data_scanner("images", startRow, stopRow, [imageColumn], {success: success, maxRows: maxRows, maxRowsIter: 5});
          });
      }
    </script>

    <script type="text/html" id="tpl_process_preprocess">
      <div class="span12 well" style="padding: 0px; margin: 0px; border: 0px">
        <div class="span3">
          <h3>Model</h3>
          <select id="model_select"></select>
        </div>
        <div class="span3">
          <%=rowSelect%>
        </div>
        <div class="span5">
          <h3>Options</h3>
          <button class="btn" type="submit" id="runButton" style="margin-bottom: 9px">Run</button>
        </div>
      </div>
      <div class="clearfix span12 skinny" id="results"></div>
    </script>

    <script type="text/javascript">
      function alert_running() {
          $('#results').html('<div class="alert alert-info"><strong>Running!</strong> Job is running, please wait...</div>');
      }
      function alert_done() {
          $('#results').html('<div class="alert alert-success"><strong>Done!</strong> Job is done.</div>');
      }
      function render_process_preprocess() {
          model_dropdown({modelFilter: function (x) {return x.pescape('data:prefix') === 'data:'},
                          el: $('#model_select')});
          row_selector($('#rowPrefixDrop'), $('#startRow'), $('#stopRow'));
          $('#runButton').click(function () {
              alert_running();
              var startRow = encode_id($('#startRow').val());
              var stopRow = encode_id($('#stopRow').val());
              function success() {
                  alert_done();
              }
              var data = {action: 'io/preprocess', model: $('#model_select').find(":selected").val()};
              picarus_api("/a1/slice/images/" + startRow + '/' + stopRow, "POST", {success: success, data: data});
          });
      }
    </script>

    <script type="text/html" id="tpl_process_feature">
      <div class="span12 well" style="padding: 0px; margin: 0px; border: 0px">
        <div class="span3">
          <h3>Model</h3>
          <select id="model_select"></select>
        </div>
        <div class="span3">
          <%=rowSelect%>
        </div>
        <div class="span5">
          <h3>Options</h3>
          <button class="btn" type="submit" id="runButton" style="margin-bottom: 9px">Run</button>
        </div>
      </div>
      <div class="clearfix span12 skinny" id="results"></div>
    </script>

    <script type="text/javascript">
      function render_process_feature() {
          model_dropdown({modelFilter: function (x) {return x.pescape('data:prefix') === 'feat:' || x.pescape('data:prefix') === 'mfeat:'},
                          el: $('#model_select')});
          row_selector($('#rowPrefixDrop'), $('#startRow'), $('#stopRow'));
          $('#runButton').click(function () {
              alert_running();
              var startRow = encode_id($('#startRow').val());
              var stopRow = encode_id($('#stopRow').val());
              function success() {
                  alert_done();
              }
              var data = {action: 'io/feature', model: $('#model_select').find(":selected").val()};
              picarus_api("/a1/slice/images/" + startRow + '/' + stopRow, "POST", {success: success, data: data});
          });
      }
    </script>

    <script type="text/html" id="tpl_process_classifier">
      <div class="span12 well" style="padding: 0px; margin: 0px; border: 0px">
        <div class="span3">
          <h3>Model</h3>
          <select id="model_select"></select>
        </div>
        <div class="span3">
          <%=rowSelect%>
        </div>
        <div class="span5">
          <h3>Options</h3>
          <button class="btn" type="submit" id="runButton" style="margin-bottom: 9px">Run</button>
        </div>
      </div>
      <div class="clearfix span12 skinny" id="results"></div>
    </script>

    <script type="text/javascript">
      function render_process_classifier() {
          model_dropdown({modelFilter: function (x) {return x.pescape('data:prefix') === 'pred:'},
                          el: $('#model_select')});
          row_selector($('#rowPrefixDrop'), $('#startRow'), $('#stopRow'));
          $('#runButton').click(function () {
              alert_running();
              var startRow = encode_id($('#startRow').val());
              var stopRow = encode_id($('#stopRow').val());
              function success() {
                  alert_done();
              }
              var data = {action: 'io/classify', model: $('#model_select').find(":selected").val()};
              picarus_api("/a1/slice/images/" + startRow + '/' + stopRow, "POST", {success: success, data: data});
          });
      }
    </script>

    <script type="text/html" id="tpl_process_hash">
      <div class="span12 well" style="padding: 0px; margin: 0px; border: 0px">
        <div class="span3">
          <h3>Model</h3>
          <select id="model_select"></select>
        </div>
        <div class="span3">
          <%=rowSelect%>
        </div>
        <div class="span5">
          <h3>Options</h3>
          <button class="btn" type="submit" id="runButton" style="margin-bottom: 9px">Run</button>
        </div>
      </div>
      <div class="clearfix span12 skinny" id="results"></div>
    </script>

    <script type="text/javascript">
      function render_process_hash() {
          model_dropdown({modelFilter: function (x) {return x.pescape('data:prefix') === 'hash:'},
                          el: $('#model_select')});
          row_selector($('#rowPrefixDrop'), $('#startRow'), $('#stopRow'));
          $('#runButton').click(function () {
              alert_running();
              var startRow = encode_id($('#startRow').val());
              var stopRow = encode_id($('#stopRow').val());
              function success() {
                  alert_done();
              }
              var data = {action: 'io/hash', model: $('#model_select').find(":selected").val()};
              picarus_api("/a1/slice/images/" + startRow + '/' + stopRow, "POST", {success: success, data: data});
          });
      }
    </script>

    <script type="text/html" id="tpl_annotate_list">
      <div class="clearfix span12 skinny" id="results">
      <div id="annotations"></div>
      </div>
    </script>

    <script type="text/javascript">
      function render_annotate_list() {
          results = new PicarusRows([], {'table': 'annotations'});
          var workerColumn = {header: "Worker", getFormatted: function() {
              return Mustache.render("<a href='/a1/annotate/{{task}}/index.html' target='_blank'>Worker</a>", {task: this.pescape('task')});
          }};
          function postRender() {
              function delete_row(data) {
                  var row = data.target.getAttribute('row');
                  results.get(row).destroy({wait: true});
              }
              button_confirm_click($('.row_delete'), delete_row);
          }
          new RowsView({collection: results, el: $('#annotations'), extraColumns: [workerColumn], postRender: postRender, deleteRows: true});
          results.fetch();
      }
    </script>
<!--
    <script type="text/html" id="tpl_annotate_entity">
      <div class="span12 well" style="padding: 0px; margin: 0px; border: 0px">
        <div class="span3">
          <%=rowSelect%>
        </div>
        <div class="span5">
          <h3>Options</h3>
          <button class="btn" type="submit" id="runButton" style="margin-bottom: 9px">Run</button>
        </div>
      </div>
      <div class="clearfix span12 skinny" id="results"></div>
    </script>

    <script type="text/javascript">
      function render_annotate_entity() {
          row_selector($('#rowPrefixDrop'), $('#startRow'), $('#stopRow'));
          $('#runButton').click(function () {
              var startRow = encode_id($('#startRow').val());
              var stopRow = encode_id($('#stopRow').val());
              var imageColumn = encode_id('thum:image_150sq');
              var entityColumn = encode_id('meta:class');
              function success(xhr) {
                  response = JSON.parse(xhr.responseText);
                  $('#results').append($('<a>').attr('href', '/a1/annotate/' + response.task + '/index.html').text('Worker').attr('target', '_blank'));
              }
              picarus_api("/a1/slice/images/" + startRow + '/' + stopRow, "POST", {success: success, data: {action: 'io/annotate/image/entity', imageColumn: imageColumn, entityColumn: entityColumn}});
          });
      }
    </script>

    <script type="text/html" id="tpl_annotate_query">
      <div class="span12 well" style="padding: 0px; margin: 0px; border: 0px">
        <div class="span3">
          <%=rowSelect%>
        </div>
        <div class="span5">
          <h3>Options</h3>
          <input class="input-small" type="text" placeholder="Query" id="query" value="">
          <button class="btn" type="submit" id="runButton" style="margin-bottom: 9px">Run</button>
        </div>
      </div>
      <div class="clearfix span12 skinny" id="results"></div>
    </script>

    <script type="text/javascript">
      function render_annotate_query() {
          row_selector($('#rowPrefixDrop'), $('#startRow'), $('#stopRow'));
          $('#runButton').click(function () {
              var startRow = encode_id($('#startRow').val());
              var stopRow = encode_id($('#stopRow').val());
              var imageColumn = encode_id('thum:image_150sq');
              var entityColumn = encode_id('meta:class');
              var query = $('#query').val();
              function success(xhr) {
                  response = JSON.parse(xhr.responseText);
                  $('#results').append($('<a>').attr('href', '/a1/annotate/' + response.task + '/index.html').text('Worker').attr('target', '_blank'));
              }
              picarus_api("/a1/slice/images/" + startRow + '/' + stopRow, "POST", {success: success, data: {action: 'io/annotate/image/query', imageColumn: imageColumn, entityColumn: entityColumn, query: query}});
          });
      }
    </script>
-->
    <script type="text/html" id="tpl_annotate_batch">
      <div class="span12 well" style="padding: 0px; margin: 0px; border: 0px">
        <div class="span3">
          <%=rowSelect%>
        </div>
        <div class="span5">
          <h3>Options</h3>
          <input class="input-small" type="text" placeholder="Query" id="query" value="">
          <button class="btn" type="submit" id="runButton" style="margin-bottom: 9px">Run</button>
        </div>
      </div>
      <div class="clearfix span12 skinny" id="results"></div>
    </script>

    <script type="text/javascript">
      function render_annotate_batch() {
          row_selector($('#rowPrefixDrop'), $('#startRow'), $('#stopRow'));
          $('#runButton').click(function () {
              var startRow = encode_id($('#startRow').val());
              var stopRow = encode_id($('#stopRow').val());
              var imageColumn = encode_id('thum:image_150sq');
              var entityColumn = encode_id('meta:class');
              var query = $('#query').val();
              function success(xhr) {
                  response = JSON.parse(xhr.responseText);
                  $('#results').append($('<a>').attr('href', '/a1/annotate/' + response.task + '/index.html').text('Worker').attr('target', '_blank'));
              }
              picarus_api("/a1/slice/images/" + startRow + '/' + stopRow, "POST", {success: success, data: {action: 'io/annotate/image/query_batch', imageColumn: imageColumn, entityColumn: entityColumn, query: query}});
          });
      }
    </script>

    <script type="text/html" id="tpl_classify_compute">
      <div class="span12 well" style="padding: 0px; margin: 0px; border: 0px">
        <div class="span3">
          <h3>Model</h3>
          <select id="model_select"></select>
        </div>
        <div class="span5">
          <h3>Options</h3>
          <input type="file" id="imagefile" class="input-small">
        </div>
      </div>
      <div class="clearfix span12 skinny" id="results"></div>
      </div>
    </script>

    <script type="text/javascript">
      function render_classify_compute() {
          model_dropdown({modelFilter: function (x) {return x.pescape('data:prefix') === 'pred:'},
                          change: function() {},
                          el: $('#model_select')});

          $('#imagefile').change(function () {
              if ($('#imagefile')[0].files.length != 1) {
                  display_alert('You must specify an image!');
                  return;
              }
              var imageColumn = encode_id('data:image');
              var modelKey = $('#model_select').find(":selected").val();
              function success_func(xhr) {
                  var result = JSON.parse(xhr.responseText);
                  if (_.isArray(result)) {
                      _.each(result, function (x) {
                          var c = _.escape(x.class);
                          var d = _.escape(x.distance);
                          var url = 'https://en.wikipedia.org/wiki/Special:Search?search=' + c.replace(' ', '_') + '&go=Go';
                          $('#results').append($('<a>').attr('href', url).text(c).attr('target', '_blank'));
                          $('#results').append(' ' + d + '<br>');
                      });
                  } else {
                      $('#results').html(xhr.responseText);
                  }
              }
              function upload_func(xhr) {
                  var response = JSON.parse(xhr.responseText);
                  picarus_api_row(table, response.row, "POST", {data: {imageColumn: imageColumn, action: 'i/classify', model: modelKey}, success: success_func})
              }
              var table = 'images';
              var data = {};
              data[imageColumn] = $('#imagefile')[0].files[0];
              picarus_api_upload(table, {data: data, success: upload_func})
              $('#results').html('');
          });
      }
    </script>

    <script type="text/html" id="tpl_classify_evaluate">
      <div class="span12 well" style="padding: 0px; margin: 0px; border: 0px">
        <div class="span3">
          <h3>Model</h3>
          <select id="model_select"></select>
        </div>
        <div class="span3">
          <%=rowSelect%>
        </div>
        <div class="span5">
          <h3>Options</h3>
          <input class="input-small" type="text" placeholder="Positive Class" id="posClass" value="" readonly="readonly">
          <input class="input-small" type="text" placeholder="GT Column" id="gtColumn" readonly="readonly" value="" >
          <input class="input-small" type="text" placeholder="Classifier Key" id="modelKey" value="" readonly="readonly">
          <button class="btn" type="submit" id="runButton" style="margin-bottom: 9px">Run</button>
      <div class="progress progress-striped active" id="progress_bar">
        <div class="bar" style="width: 0%;"  id="progress"></div>
      </div>
        </div>
      </div>
      <div class="clearfix span12 skinny" id="results">
        <div id="base" style="position:relative;top:-35px;"></div>
        <div id="graph_confidence_scatter" style="height:200px;width:600px"></div>
        <div id="graph_confidence_scatter_norm" style="height:200px;width:600px"></div>
        <div id="graph_confidence_accuracy" style="height:200px;width:600px"></div>
        <div id="graph_rps" style="height:300px;width:300px;float:left;"></div>
        <div id="graph_roc" style="height:300px;width:300px;float:left;"></div>
      </div>
    </script>
    <script type="text/javascript">
      function render_classify_evaluate() {
          model_dropdown({modelFilter: function (x) {return x.pescape('data:prefix') === 'pred:' && x.pescapejs('data:param').classifier_type === "c2tsZWFybl9kZWNpc2lvbl9mdW5j"},
                          change: function() {
                              var row = this.$el.find(":selected").val();
                              m = this.collection.get(row);
                              $('#gtColumn').val(m.pescapejs('data:input').meta);
                              $('#posClass').val(base64.decode(m.pescapejs('data:param').class_positive));
                              $('#modelKey').val(row);
                          },
                          el: $('#model_select')});
          row_selector($('#rowPrefixDrop'), $('#startRow'), $('#stopRow'));
          $('#runButton').click(function () {
          confs = {pos_confs: [], neg_confs: []};
          var gt_column = $('#gtColumn').val();
          var conf_column = $('#modelKey').val();
          var startRow = encode_id($('#startRow').val());
          var stopRow = encode_id($('#stopRow').val());
          var posClass = $('#posClass').val();
          $('#progress_bar').show()
          function success(row, columns) {
              $('#progress').css('width', (100 * (confs.pos_confs.length + confs.neg_confs.length) / 19850.) + '%')
              if (columns.hasOwnProperty(conf_column)) {
                  if (base64.decode(columns[gt_column]) == posClass) {
                      confs.pos_confs.push(Number(base64.decode(columns[conf_column])));
                  } else {
                      confs.neg_confs.push(Number(base64.decode(columns[conf_column])));
                  }
              } else {
                  console.log('Row without confidence');
              }
          }
              function success_confs() {
                  $('#progress_bar').hide()
                  confs.neg_confs.sort(function(a, b) {return a - b});
                  confs.pos_confs.sort(function(a, b) {return a - b});
                  plot_confs(confs);
              }
              picarus_api_data_scanner("images", startRow, stopRow, [gt_column, conf_column], {success: success, done: success_confs});
          })
      }
      function confs_to_conf_hist(pos_confs, neg_confs, bins, normalize) {
          /* Takes in confs, produces a histogram capturing both pos/neg confs in each bin
             TODO: Check that each bin gets get an equal portion of the range
           */
          var min_conf = Math.min(pos_confs[0], neg_confs[0]);
          var max_conf = Math.min(pos_confs[pos_confs.length - 1], neg_confs[neg_confs.length - 1]);
          var shift = min_conf;
          var scale = bins / (max_conf - min_conf);
          var pos_buckets = [];
          var neg_buckets = [];
          var coords = [];
          var i, cur_bucket;
          for (i = 0; i < bins; i++) {
              pos_buckets[i] = 0;
              neg_buckets[i] = 0;
          }
          for (i = 0; i < pos_confs.length; i++) {
              pos_buckets[Math.min(bins - 1, Math.max(0, Math.floor((pos_confs[i] - shift) * scale)))] += 1;
          }
          for (i = 0; i < neg_confs.length; i++) {
              neg_buckets[Math.min(bins - 1, Math.max(0, Math.floor((neg_confs[i] - shift) * scale)))] += 1;
          }
          for (i = 0; i < bins; i++) {
              coords[i] = [(i + .5) / scale + shift, pos_buckets[i], neg_buckets[i]];
              if (normalize) {
                  coords[i][1] /= pos_confs.length;
                  coords[i][2] /= neg_confs.length;
              }
          }
          return coords;
      }
      function test_confs_to_confusion_matrix() {
          //var cms;
          cms = confs_to_confusion_matrix([], []);
          if (!_.isEqual(cms, []))
              return 1;

          cms = confs_to_confusion_matrix([0], []);
          if (!_.isEqual(cms, [[1, 0, 0, 0, 0]]))
              return 2;

          cms = confs_to_confusion_matrix([], [0]);
          if (!_.isEqual(cms, [[0, 0, 1, 0, Infinity]]))
              return 3;

          cms = confs_to_confusion_matrix([0], [0]);
          if (!_.isEqual(cms, [[1, 1, 0, 0, 0], [0, 0, 1, 1, Infinity]]))
              return 4;

          cms = confs_to_confusion_matrix([1], [0]);
          if (!_.isEqual(cms, [[1, 0, 1, 0, 1]]))
              return 5;

          cms = confs_to_confusion_matrix([0], [1]);
          if (!_.isEqual(cms, [[1, 1, 0, 0, 0], [0, 0, 1, 1, Infinity]]))
              return 6;

          cms = confs_to_confusion_matrix([0, 0], [0]);
          if (!_.isEqual(cms, [[2, 1, 0, 0, 0], [0, 0, 1, 2, Infinity]]))
              return 7;

          cms = confs_to_confusion_matrix([0, 1], [0]);
          if (!_.isEqual(cms, [[2, 1, 0, 0, 0], [1, 0, 1, 1, 1]]))
              return 8;

          cms = confs_to_confusion_matrix([0, 0], [1]);
          if (!_.isEqual(cms, [[2, 1, 0, 0, 0], [0, 0, 1, 2, Infinity]]))
              return 9;

          cms = confs_to_confusion_matrix([1, 2], [0]);
          if (!_.isEqual(cms, [[2, 0, 1, 0, 1]]))
              return 10;

          cms = confs_to_confusion_matrix([0, 2], [1]);
          if (!_.isEqual(cms, [[2, 1, 0, 0, 0], [1, 0, 1, 1, 2]]))
              return 11;

          cms = confs_to_confusion_matrix([0, 1], [2]);
          if (!_.isEqual(cms, [[2, 1, 0, 0, 0], [0, 0, 1, 2, Infinity]]))
              return 12;

          cms = confs_to_confusion_matrix([1, 2], [0, 3]);
          if (!_.isEqual(cms, [[2, 1, 1, 0, 1], [0, 0, 2, 2, Infinity]]))
              return 13;

          cms = confs_to_confusion_matrix([1, 2, 3], [0, 3]);
          if (!_.isEqual(cms, [[3, 1, 1, 0, 1], [0, 0, 2, 3, Infinity]]))
              return 14;

          cms = confs_to_confusion_matrix([1, 2, 3, 3], [0, 3]);
          if (!_.isEqual(cms, [[4, 1, 1, 0, 1], [0, 0, 2, 4, Infinity]]))
              return 15;
          return 0;
      }
      function confs_to_confusion_matrix(pos_confs, neg_confs) {
          /* Takes in confs, produces list of [tp, fp, tn, fn, thresh] */
          var cm_threshs = [];
          var fn = 0;
          var tn = 0;
          var i;
          var cur_thresh;
          while (pos_confs.length || neg_confs.length) {
              // Skip Negatives
              for (i = 0; i < neg_confs.length; i++) {
                  if (neg_confs[i] >= pos_confs[0]) {
                      break;
                  }
              }
              neg_confs = neg_confs.slice(i, neg_confs.length);
              tn += i;
              // Add PR point (cur_thresh = pos_confs[0])
              if (pos_confs.length) {
                  cur_thresh = pos_confs[0];
              } else {
                  cur_thresh = Infinity;
              }
              cm_threshs.push([pos_confs.length, neg_confs.length, tn, fn, cur_thresh]);
              // Skip Positives
              for (i = 0; i < pos_confs.length; i++) {
                  if (pos_confs[i] > neg_confs[0]) {
                      break;
                  }
              }
              pos_confs = pos_confs.slice(i, pos_confs.length);
              fn += i;
          }
          return cm_threshs;
      }
      function cms_to_rps(cms) {
          var rps = [];
          var i;
          for (i = 0; i < cms.length; i++) {
              rps.push([cms[i][0] / (cms[i][0] + cms[i][3]), cms[i][0] / (cms[i][0] + cms[i][1]), cms[i][4]])
          }
          return rps;
      }
      function cms_to_conf_accs(cms) {
          var conf_accs = [];
          var i;
          for (i = 0; i < cms.length; i++) {
              conf_accs.push([cms[i][4], (cms[i][0] + cms[i][2]) / (cms[i][0] + cms[i][1] + cms[i][2] + cms[i][3])])
          }
          return conf_accs;
      }
      function cms_to_fpr_tprs(cms) {
          var fpr_tprs = [];
          var i, fpr, tpr;
          var p = confs.pos_confs.length;
          var n = confs.neg_confs.length;
          for (i = 0; i < cms.length; i++) {
              fpr = cms[i][1] / n; // FP / N
              tpr = cms[i][0] / p; // TP / P
              fpr_tprs.push([fpr, tpr, cms[i][4]]);
          }
          return fpr_tprs;
      }
      function to_google_data(pts, labels, tooltip) {
          var i;
          var data = new google.visualization.DataTable();
          for (i = 0; i < labels.length; i++) {
              data.addColumn('number', labels[i]);
          }
          if (tooltip) {
              data.addColumn({type: 'number', role: 'tooltip'});
          }
          data.addRows(pts);
          return data;
      }
      function plot_confs(confs) {
          var test_out = test_confs_to_confusion_matrix();
          if (test_out)
              alert(test_out);
          var data0 = to_google_data(confs_to_conf_hist(confs.pos_confs, confs.neg_confs, 100), ['Confidence', '+', '-']);
          var options = {title: 'Classifier Confidence',
                         hAxis: {title: 'Confidence'}};
          var chart0 = new google.visualization.LineChart(document.getElementById('graph_confidence_scatter'));
          chart0.draw(data0, options);

          var data1 = to_google_data(confs_to_conf_hist(confs.pos_confs, confs.neg_confs, 100, true), ['Confidence', '+', '-']);
          options = {title: 'Classifier Confidence (normalized)',
                     hAxis: {title: 'Confidence'}};
          var chart1 = new google.visualization.LineChart(document.getElementById('graph_confidence_scatter_norm'));
          chart1.draw(data1, options);

          // PR Curve
          var cms = confs_to_confusion_matrix(confs.pos_confs, confs.neg_confs);
          // Confidence accuracy
          var data4 = to_google_data(cms_to_conf_accs(cms), ['Confidence', 'Accuracy']);
          options = {title: 'Classifier Confidence vs Accuracy',
                     hAxis: {title: 'Confidence'}};
          var chart4 = new google.visualization.LineChart(document.getElementById('graph_confidence_accuracy'));
          chart4.draw(data4, options);
          var data2 = to_google_data(cms_to_rps(cms), ['recall', 'precision'], true);
          options = {title: 'PR Curve',
                     hAxis: {title: 'Recall', minValue: 0, maxValue: 1},
                     vAxis: {title: 'Precision', minValue: 0, maxValue: 1},
                     chartArea: {width: 200, height: 200},
                     legend: {position: 'none'}};
          var chart2 = new google.visualization.LineChart(document.getElementById('graph_rps'));
          chart2.draw(data2, options);

          var data3 = to_google_data(cms_to_fpr_tprs(cms), ['fpr', 'tpr'], true);
          options = {title: 'ROC Curve',
                     hAxis: {title: 'FPR', minValue: 0, maxValue: 1},
                     vAxis: {title: 'TPR', minValue: 0, maxValue: 1},
                     chartArea: {width: 200, height: 200},
                     legend: {position: 'none'}};
          var chart3 = new google.visualization.LineChart(document.getElementById('graph_roc'));
          chart3.draw(data3, options);

          
          // This connects all the charts together
          function setNearest(chart, data, column, select_columns, val) {
              var i, minVal = Infinity, minIndex, curVal;
              for (i = 0; i < data.getNumberOfRows(); i++) {
                  curVal = Math.abs(val - data.getValue(i, column));
                  if (curVal < minVal) {
                      minVal = curVal;
                      minIndex = i;
                  }
              }
                              
              chart.setSelection(_.map(select_columns, function (col) {return {row: minIndex, column: col}}));
          }
          function setSelections(thresh) {
              setNearest(chart0, data0, 0, [1, 2], thresh);
              setNearest(chart1, data1, 0, [1, 2], thresh);
              setNearest(chart2, data2, 2, [1], thresh);
              setNearest(chart3, data3, 2, [1], thresh);
              setNearest(chart4, data4, 0, [1], thresh);
          }
          var al = google.visualization.events.addListener;
          al(chart0, 'select', function () {var sel = chart0.getSelection(); if (sel[0] !== undefined) setSelections(data0.getValue(sel[0].row, 0))});
          al(chart1, 'select', function () {var sel = chart1.getSelection(); if (sel[0] !== undefined) setSelections(data1.getValue(sel[0].row, 0))});
          al(chart2, 'select', function () {var sel = chart2.getSelection(); if (sel[0] !== undefined) setSelections(data2.getValue(sel[0].row, 2))});
          al(chart3, 'select', function () {var sel = chart3.getSelection(); if (sel[0] !== undefined) setSelections(data3.getValue(sel[0].row, 2))});
          al(chart4, 'select', function () {var sel = chart4.getSelection(); if (sel[0] !== undefined) setSelections(data4.getValue(sel[0].row, 0))});
      }
    </script>

    <script type="text/html" id="tpl_index_compute">
      <div class="span12 well" style="padding: 0px; margin: 0px; border: 0px">
        <div class="span3">
          <h3>Model</h3>
          <select id="model_select"></select>
        </div>
        <div class="span5">
          <h3>Options</h3>
          <input class="input-small" type="text" placeholder="Index Key" id="modelKey" value="" readonly="readonly">
          <input type="file" id="imagefile" class="input-small">
        </div>
      </div>
      <div class="clearfix span12 skinny" id="results"></div>
    </script>
    
    <script type="text/javascript">
      function load_image(table, row, imageColumn, id) {
          function success_img_func(xhr) {
              var response = JSON.parse(xhr.responseText);
              $('#' + id).attr('src', 'data:image/jpeg;base64,' + response[imageColumn]);
          }
          picarus_api_row(table, row, "GET", {data: {column: imageColumn}, success: success_img_func});
      }
      function render_index_compute() {
          model_dropdown({modelFilter: function (x) {return x.pescape('data:prefix') === 'srch:'},
                          change: function() {
                              var row = this.$el.find(":selected").val();
                              m = this.collection.get(row);
                              $('#modelKey').val(row);
                          },
                          el: $('#model_select')});
          $('#imagefile').change(function () {
              if ($('#imagefile')[0].files.length != 1) {
                  display_alert('You must specify an image!');
                  return;
              }
              var imageColumn = encode_id('data:image')
              var thumbColumn = encode_id('thum:image_150sq')
              var modelKey = $('#modelKey').val();
              function success_func(xhr) {
                  resp = JSON.parse(xhr.responseText);
                  $.each(resp, function (x, y) {
                      var cur_id = 'result_' + x;
                      $('#results').append($('<img>').attr('id', cur_id));
                      $('#results').append(y[0]);
                      $('#results').append($('<br>'));
                      load_image(table, y[1], thumbColumn, cur_id)
                      /*function success_img_func(xhr) {
                          var response = JSON.parse(xhr.responseText);
                          $('#' + cur_id).attr('width', '150px').attr('src', 'data:image/jpeg;base64,' + response[thumbColumn]);
                      }
                      picarus_api_row(table, y[1], "GET", {data: {imageColumn: thumbColumn}, success: success_img_func}); */
                  });
              }
              function upload_func(xhr) {
                  var response = JSON.parse(xhr.responseText);
                  picarus_api_row(table, response.row, "POST", {data: {imageColumn: imageColumn, action: 'i/search', model: modelKey}, success: success_func})
              }
              var table = 'images';
              var data = {};
              data[imageColumn] = $('#imagefile')[0].files[0];
              picarus_api_upload(table, {data: data, success: upload_func})
          })
      }
    </script>

    <script type="text/html" id="tpl_visualize_thumbnails">
        <div class="span12 well" style="padding: 0px; margin: 0px; border: 0px">
          <div class="span5">
          <%=rowSelect%>
          </div>
          <div class="span5">
          <h3>Options</h3>
          <%=filter%>
          <button class="btn" type="submit" id="runButton" style="margin-bottom: 9px">Run</button>
          </div>
        </div>
      <div class="clearfix span12 skinny" style="padding-left:20px; padding-right:20px" id="results"></div>
    </script>

    <script type="text/javascript">
      function render_visualize_thumbnails() {
          row_selector($('#rowPrefixDrop'), $('#startRow'), $('#stopRow'));
          $('#runButton').click(function () {
              var startRow = encode_id(unescape($('#startRow').val()));
              var stopRow = encode_id(unescape($('#stopRow').val()));
              var imageColumn = encode_id('thum:image_150sq');
              var metaCF = encode_id('meta:');
              if (startRow.length == 0 || stopRow.length == 0) {
                  display_alert('Must specify rows');
                  return;
              }
              $('#results').html('');
              function success(row, columns) {
                  if (!_.has(columns, imageColumn))
                      return;
                  $('#results').append($('<img>').attr('src', 'data:image/jpeg;base64,' + columns[imageColumn]).attr('title', row))
                  //$('#results').append($('<br>'));
              }
              var params = {success: success, maxRows: 100};
              var filter = unescape($('#filter').val());
              if (filter.length > 0) {
                  params.filter = filter;
              }
              picarus_api_data_scanner("images", startRow, stopRow, [imageColumn, metaCF], params)
          });
      }
    </script>


    <script type="text/html" id="tpl_visualize_metadata">
        <div class="span12 well" style="padding: 0px; margin: 0px; border: 0px">
          <div class="span5">
          <%=rowSelect%>
          </div>
          <div class="span5">
          <h3>Options</h3>
          <%=filter%>
          <input class="input-small" type="text" placeholder="Max Size" id="maxSize" value="128">
          <button class="btn" type="submit" id="runButton" style="margin-bottom: 9px">Run</button>
          <button class="btn" type="submit" id="removeButton" style="margin-bottom: 9px" disabled>Remove</button>
          </div>
        </div>
      <div class="clearfix span12 skinny" id="results"></div>
    </script>

    <script type="text/javascript">
      function render_visualize_metadata() {
          row_selector($('#rowPrefixDrop'), $('#startRow'), $('#stopRow'));
          $('#runButton').click(function () {
              var startRow = encode_id(unescape($('#startRow').val()));
              var stopRow = encode_id(unescape($('#stopRow').val()));
              var max_size = Number($('#maxSize').val());
              var metaCF = encode_id('meta:');
              if (startRow.length == 0 || stopRow.length == 0) {
                  display_alert('Must specify rows');
                  return;
              }
              button_confirm_click_reset($('#removeButton'));
              // Setup table
              images = new PicarusImages();
              function remove_rows() {
                 // TODO: Since there is a maxRows setting, this won't remove all rows, just the ones we have available
                 var rows = _.map(images.models, function (x) {return x.id})
                 picarus_api_delete_rows(rows, progressModal());
              }
              function done() {
                  $('#results').html('');
                  if (!images.length)
                      return;
                  var AppView = Backbone.View.extend({
                      initialize: function() {
                          _.bindAll(this, 'render');
                          this.collection.bind('reset', this.render);
                          this.collection.bind('change', this.render);
                          this.collection.bind('add', this.render);
                      },
                      render: function() {
                          var columns = _.uniq(_.flatten(_.map(this.collection.models, function (x) {
                              return _.keys(x.attributes);
                          })));
                                  picarus_table = new Backbone.Table({
                                  collection: this.collection,
                                  columns: _.map(columns, function (v) {
                                          if (v === "row")
                                              return [v, v];
                                          return {header: base64.decode(v), getFormatted: function() {
                                              var out = this.get(v);
                                              if (typeof out !== 'undefined') {
                                                  out = base64.decode(out);
                                                  if (out.length <= max_size)
                                                      return out;
                                                  else
                                                      return '<span style="color:red">' + out.slice(0, max_size) + '</span>'
                                              }
                                          }};
                                      })
                                  });
                                  this.$el.html(picarus_table.render().el);
                              }
                  });
                  av = new AppView({collection: images, el: $('#results')});
                  av.render();
                  $('#removeButton').removeAttr('disabled');
                  button_confirm_click($('#removeButton'), remove_rows);
              }
              function success(row, columns) {
                  c=columns;
                  columns.row = row;
                  images.add(columns);
              }
              var params = {success: success, maxRows: 1000, done: done};
              var filter = unescape($('#filter').val());
              if (filter.length > 0) {
                  params.filter = filter;
              }
              picarus_api_data_scanner("images", startRow, stopRow, [metaCF], params)
          });
      }
    </script>

    <script type="text/html" id="tpl_visualize_exif">
        <div class="span12 well" style="padding: 0px; margin: 0px; border: 0px">
          <div class="span5">
          <%=rowSelect%>
          </div>
          <div class="span5">
          <h3>Options</h3>
          <%=filter%>
          <input class="input-small" type="text" placeholder="Max Size" id="maxSize" value="128">
          <button class="btn" type="submit" id="runButton" style="margin-bottom: 9px">Run</button>
          <button class="btn" type="submit" id="removeButton" style="margin-bottom: 9px" disabled>Remove</button>
          </div>
        </div>
      <div class="clearfix span12 skinny" id="results"></div>
    </script>

    <script type="text/javascript">
      function render_visualize_exif() {
          row_selector($('#rowPrefixDrop'), $('#startRow'), $('#stopRow'));
          // TODO: Fix for exif
          $('#runButton').click(function () {
              var startRow = encode_id(unescape($('#startRow').val()));
              var stopRow = encode_id(unescape($('#stopRow').val()));
              var max_size = Number($('#maxSize').val());
              var metaCF = encode_id('meta:');
              if (startRow.length == 0 || stopRow.length == 0) {
                  display_alert('Must specify rows');
                  return;
              }
              button_confirm_click_reset($('#removeButton'));
              // Setup table
              images = new PicarusImages();
              var exif_column = encode_id('meta:exif');
              function remove_rows() {
                 // TODO: Since there is a maxRows setting, this won't remove all rows, just the ones we have available
                 var rows = _.map(images.models, function (x) {return x.id})
                 picarus_api_delete_rows(rows, progressModal());
              }
              function done() {
                  $('#results').html('');
                  if (!images.length)
                      return;
                  var AppView = Backbone.View.extend({
                      initialize: function() {
                          _.bindAll(this, 'render');
                          this.collection.bind('reset', this.render);
                          this.collection.bind('change', this.render);
                          this.collection.bind('add', this.render);
                      },
                      render: function() {
                          var cur_images = this.collection.filter(function (x) {return x.get(exif_column) != 'e30=' && !_.isUndefined(x.get(exif_column))});
                          columns = _.uniq(_.flatten(_.map(cur_images, function (x) {
                              return _.keys(JSON.parse(base64.decode(x.get(exif_column))));
                          }))).concat(['row']);
                                  picarus_table = new Backbone.Table({
                                  collection: this.collection,
                                  columns: _.map(columns, function (v) {
                                          if (v === "row")
                                              return [v, v];
                                          return {header: v, getFormatted: function() {
                                              var cur_exif = JSON.parse(base64.decode(this.get(exif_column)));
                                              var out = cur_exif[v];
                                              if (typeof out !== 'undefined') {
                                                  if (!_.isString(out))
                                                      return _.escape(JSON.stringify(out));
                                                  out = base64.decode(out);
                                                  if (typeof out.length <= max_size)
                                                      return _.escape(out);
                                                  else
                                                      return '<span style="color:red">' + _.escape(out.slice(0, max_size)) + '</span>'
                                              }
                                          }};
                                      })
                                  });
                                  this.$el.html(picarus_table.render().el);
                              }
                  });
                  av = new AppView({collection: images, el: $('#results')});
                  av.render();
                  $('#removeButton').removeAttr('disabled');
                  button_confirm_click($('#removeButton'), remove_rows);
              }
              function success(row, columns) {
                  c=columns;
                  columns.row = row;
                  if (columns[exif_column] != 'e30=')
                      images.add(columns);
              }
              var params = {success: success, maxRows: 1000, done: done};
              var filter = unescape($('#filter').val());
              if (filter.length > 0) {
                  params.filter = filter;
              }
              picarus_api_data_scanner("images", startRow, stopRow, [metaCF], params)
          });
      }
    </script>

    <script type="text/html" id="tpl_visualize_duplicates">
        <div class="span12 well" style="padding: 0px; margin: 0px; border: 0px">
          <div class="span5">
          <%=rowSelect%>
          </div>
          <div class="span5">
          <h3>Options</h3>
          <button class="btn" type="submit" id="runButton" style="margin-bottom: 9px">Run</button>
          <button class="btn" type="submit" id="nextButton" style="margin-bottom: 9px" disabled>Next</button>
          <button class="btn" type="submit" id="removeButton" style="margin-bottom: 9px" disabled>Remove</button>
          </div>
        </div>
      <div class="clearfix span12 skinny" id="results"></div>
    </script>

    <script type="text/javascript">
      function button_confirm_click(button, fun) {
          button.unbind();
          button.click(function (data) {
              var button = $(data.target);
              button.unbind();
              button.addClass('btn-danger');
              button.click(fun);
          });
      }
      function button_confirm_click_reset(button) {
          button.removeClass('btn-danger');
          button.unbind();
      }
      function render_visualize_duplicates() {
          row_selector($('#rowPrefixDrop'), $('#startRow'), $('#stopRow'));
          $('#runButton').click(function () {
              var startRow = encode_id(unescape($('#startRow').val()));
              var stopRow = encode_id(unescape($('#stopRow').val()));
              var imageColumn = encode_id('data:image');
              var thumbColumn = encode_id('thum:image_150sq');
              if (startRow.length == 0 || stopRow.length == 0) {
                  display_alert('Must specify rows');
                  return;
              }
              button_confirm_click_reset($('#removeButton'));
              alert_running();
              function display_clusters (clusters) {
                  var num = 30;
                  var next_clusters = clusters.slice(num);
                  var cur_clusters = clusters.slice(0, num);
                  var el = $('#results');
                  el.empty();
                  $('#nextButton').unbind();
                  if (next_clusters.length) {
                      $('#nextButton').removeAttr('disabled');
                      $('#nextButton').click(function () {display_clusters(next_clusters)});
                  } else {
                      $('#nextButton').attr('disabled', '');
                  }
                  _.each(cur_clusters, function (x) {
                      _.each(x.rows, function (y) {
                          var cur_id = _.uniqueId('image_');
                          el.append($('<img>').attr('id', cur_id));
                          load_image('images', y, thumbColumn, cur_id);
                      })
                      el.append($('<br>'));
                  });
              }
              function remove_dupes(clusters) {
                 var rows = [];
                 _.each(clusters, function (x) {rows = rows.concat(_.shuffle(x.rows).slice(1));console.log(rows.length)});
                 picarus_api_delete_rows(rows, progressModal());
              }
              function success_func(xhr) {
                  alert_done();
                  var dedupe_response = JSON.parse(xhr.responseText);
                  $('#removeButton').removeAttr('disabled');
                  button_confirm_click($('#removeButton'), function () {remove_dupes(dedupe_response)})
                  display_clusters(dedupe_response);
                  /*
                  PicarusImageCluster = Backbone.Model.extend({});
                  PicarusImageClusters = Backbone.Collection.extend({model: PicarusImageCluster});
                  clusters = new PicarusImageClusters();
                  var AppView = Backbone.View.extend({
                      initialize: function() {
                          _.bindAll(this, 'render');
                          this.collection.bind('reset', this.render);
                          this.collection.bind('change', this.render);
                      },
                      render: function() {
                                  this.$el.empty();

                              }
                  });
                  new AppView({collection: clusters, el: $('#results')});
                  clusters.reset(dedupe_response);
                 */
              }
              picarus_api("/a1/slice/images/" + startRow + '/' + stopRow, "POST", {success: success_func, data: {action: 'i/dedupe/identical', column: imageColumn}});
          });
      }
    </script>

    <script type="text/html" id="tpl_visualize_locations">
        <div class="span12 well" style="padding: 0px; margin: 0px; border: 0px">
          <div class="span5">
          <%=rowSelect%>
          </div>
          <div class="span5">
          <h3>Options</h3>
          <%=filter%>
          <input class="input-small" type="text" placeholder="Target Latitude" id="demolat" value="">
          <input class="input-small" type="text" placeholder="Target Longitude" id="demolong" value="">
          <input class="input-small" type="text" placeholder="Max Distance" id="demodist" value="5">
          <input class="input-small" type="checkbox" id="filterInvert">
          <button class="btn" type="submit" id="runButton" style="margin-bottom: 9px">Run</button>
          <button class="btn" type="submit" id="removeButton" style="margin-bottom: 9px" disabled>Remove</button>
          </div>
        </div>
      <div id="map_canvas" style="width:100%; height:500px"></div>
    </script>

    <script type="text/javascript">
      function deg2rad(deg) {
          return deg * (Math.PI/180)
      }
      function getDistanceFromLatLonInKm(lat1,lon1,lat2,lon2) {
         // From: http://stackoverflow.com/questions/27928/how-do-i-calculate-distance-between-two-latitude-longitude-points
         var R = 6371; // Radius of the earth in km
         var dLat = deg2rad(lat2-lat1);
         var dLon = deg2rad(lon2-lon1); 
         var a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2); 
         var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
         var d = R * c; // Distance in km
         return d;
      }
      function filter_lat_long(lat, long) {
          var targetLat = Number($('#demolat').val());
          var targetLong = Number($('#demolong').val());
          var targetDist = Number($('#demodist').val());
          var checked = $('#filterInvert').is(':checked');
          if (!targetLat || !targetLong)
              return checked;
          if (getDistanceFromLatLonInKm(targetLat, targetLong, lat, long) > targetDist)
              return !checked;
          return checked;
      }
      function render_visualize_locations() {
          row_selector($('#rowPrefixDrop'), $('#startRow'), $('#stopRow'));
          $('#runButton').click(function () {
              var latitude = encode_id('meta:latitude');
              var longitude = encode_id('meta:longitude');
              button_confirm_click_reset($('#removeButton'));
              images = new PicarusImages();
              function maps_success(row, columns) {
                  columns.row = row;
                  var curLat = base64.decode(columns[latitude]);
                  var curLong = base64.decode(columns[longitude]);
                  if (filter_lat_long(Number(curLat), Number(curLong))) {
                      return;
                  }
                  images.add(new PicarusImage(columns));
              }
              function maps_done() {
                  var centerLat = Number($('#demolat').val());
                  var centerLong = Number($('#demolong').val());
                  button_confirm_click($('#removeButton'), function () {
                      var rows = _.map(images.models, function (x) {return x.get('row')});
                      picarus_api_delete_rows(rows, progressModal());
                  });
                  $('#removeButton').removeAttr('disabled');
                  if (!centerLat || !centerLat) {
                      centerLat = Number(base64.decode(images.at(0).get(latitude)));
                      centerLong = Number(base64.decode(images.at(0).get(longitude)));
                  }
                  var mapOptions = {
                      zoom: 14,
                      center: new google.maps.LatLng(centerLat, centerLong),
                      mapTypeId: google.maps.MapTypeId.HYBRID
                  };
                   map = new google.maps.Map(document.getElementById("map_canvas"),
                      mapOptions);
                  google.maps.event.addListener(map, 'rightclick', function(event){
                      $('#demolat').val(event.latLng.lat());
                      $('#demolong').val(event.latLng.lng());
                  });
                  images.each(function (x) {
                      var lat = Number(base64.decode(x.get(latitude)));
                      var long = Number(base64.decode(x.get(longitude)));
                      new google.maps.Marker({position: new google.maps.LatLng(lat, long), map: map});
                  });
              }
              picarus_api_data_scanner("images", encode_id(unescape($('#startRow').val())), encode_id(unescape($('#stopRow').val())), [latitude, longitude], {success: maps_success, done: maps_done});
          })
      }
    </script>

    <script type="text/html" id="tpl_visualize_times">
        <div class="span12 well" style="padding: 0px; margin: 0px; border: 0px">
          <div class="span5">
          <%=rowSelect%>
          </div>
          <div class="span5">
          <h3>Options</h3>
          <button class="btn" type="submit" id="runButton" style="margin-bottom: 9px">Run</button>
        </div>
      <div id="histYear"></div>
      <div id="histMonth"></div>
      <div id="histHour"></div>
      <div id="histDay"></div>
    </script>

    <script type="text/javascript">
      function render_visualize_times() {
          row_selector($('#rowPrefixDrop'), $('#startRow'), $('#stopRow'));
          function drawYears(hist) {
              var data = google.visualization.arrayToDataTable([['Year', 'Count']].concat(hist));
              new google.visualization.ColumnChart(document.getElementById('histYear')).draw(data, {title:"Histogram (Year)", width:600, height:400, vAxis: {title: "Count"}, hAxis: {title: "Year"}});
          }
          function drawMonths(hist) {
              var data = google.visualization.arrayToDataTable([['Month', 'Count']].concat(hist));
              new google.visualization.ColumnChart(document.getElementById('histMonth')).draw(data, {title:"Histogram (Month)", width:600, height:400, vAxis: {title: "Count"}, hAxis: {title: "Month"}});
          }
          function drawHours(hist) {
              var data = google.visualization.arrayToDataTable([['Hour', 'Count']].concat(hist));
              new google.visualization.ColumnChart(document.getElementById('histHour')).draw(data, {title:"Histogram (Hour)", width:600, height:400, vAxis: {title: "Count"}, hAxis: {title: "Hour"}});
          }
          function drawDays(hist) {
              var data = google.visualization.arrayToDataTable([['Day', 'Count']].concat(hist));
              new google.visualization.ColumnChart(document.getElementById('histDay')).draw(data, {title:"Histogram (Day)", width:600, height:400, vAxis: {title: "Count"}, hAxis: {title: "Day"}});
          }
      function dataToHist(data) {
          var hist = {};
          _.each(data, function (x) {
              var y = 0;
              if (_.has(hist, x)) {
                  y = hist[x];
              }
              hist[x] = y + 1;
          });
          return hist;
      }
      function dataToListHist(data) {
          return _.pairs(dataToHist(data)).sort();
      }
          $('#runButton').click(function () {
          var timeColumn = encode_id('meta:dateupload');
              images = new PicarusImages();
              function time_success(row, columns) {
                  columns.row = row;
                  images.add(new PicarusImage(columns));
              }
              function time_done() {
                  years = [];
                  months = [];
                  hours = [];
                  days = [];
                  // TODO: FInish visual
                  images.each(function (x) {
                      var curTime = Number(base64.decode(x.get(timeColumn)));
                      var curDate = new Date(0);
                      curDate.setUTCSeconds(curTime);
                      years.push(curDate.getFullYear());
                      months.push(curDate.getMonth());
                      hours.push(curDate.getHours());
                      days.push(curDate.getDay());
                  });
                  drawYears(dataToListHist(years));
                  drawMonths(dataToListHist(months));
                  drawHours(dataToListHist(hours));
                  drawDays(dataToListHist(days));
              }
          picarus_api_data_scanner("images", encode_id(unescape($('#startRow').val())), encode_id(unescape($('#stopRow').val())), [timeColumn], {success: time_success, done: time_done});
      })
      }
    </script>

    <script type="text/html" id="tpl_visualize_annotations">
        <div class="span12 well" style="padding: 0px; margin: 0px; border: 0px">
          <div class="span12">
          <h3>Options</h3>
          <select id="annotator_select"></select>
          <input class="input-mini" type="text" hint="Negative if: neg / total >=" id="negPct" value="1">
          <input class="input-mini" type="text" hint="Negative if: neg >=" id="negCnt" value="1">
          <input class="input-mini" type="text" hint="Positive if: pos / total >=" id="posPct" value="1">
          <input class="input-mini" type="text" hint="Positive if: pos >=" id="posCnt" value="1">
          <label class="checkbox" style="margin-bottom: 0px;" hint="Include 'unclicked' images" for="unclicked">
            <input type="checkbox" value="" id="unclicked">
          </label>
          </div>
          <div class="span8">
            <div class="span2">
          <h3>Split Actions</h3>
          <select id="actionSplit" class="input-small" hint="Splits class to modify (defined by thresholds above)">
            <option value='positive'>Positive</option>
            <option value='negative'>Negative</option>
            <option value='other'>Other</option>
          </select>
          </div>
          <div class="span8 well">
            <div class="span2">
              <button class="btn" type="submit" id="removeButton" style="margin-bottom: 9px;margin-top: 9px" hint="Remove all rows in the split">Remove</button>
            </div>
            <div class="span1" style="margin-top: 12px">
              <strong>OR</strong>
              </div>
            <div class="span4">
              <input class="input-small" type="text" hint="Column Name" id="colName" value="meta:class">
              <input class="input-small" type="text" hint="Column Value" id="colValue" value="">
              <button class="btn" type="submit" id="modifyButton" style="margin-bottom: 9px" hint="Set a column to a value for all rows in the split">Modify</button>
            </div>
          </div>
        </div>
      <div class="clearfix span12 skinny" style="padding-left:20px; padding-right:20px" id="results">
      <div id="positive_samples"></div>
      <div id="negative_samples"></div>
      <div id="other_samples"></div>
      <h3>Users Table</h3>
      <div id="annotation-users"></div>
      <h3>Results Table</h3>
      <div id="annotation-results"></div>
      </div>
    </script>

    <script type="text/javascript">
      function render_visualize_annotations() {
          var rows = new PicarusRows([], {'table': 'annotations'});
          function accumulate(hist, vals, inc) {
              _.each(vals, function (x) {
                  if (_.has(hist, x))
                      hist[x] += inc;
                  else
                      hist[x] = inc;
              });
          }
          function image_batch_score(users, results, scoreUnselected) {
              // Only count explicit marks
              scoresPos = {};
              scoresNeg = {};
              scoresTotal = {};

              pick = function (s, l) { return _.map(s, function (x) {return l[x]});}

              results.each(function (x) {
                  d = x.pescapejs('user_data');
                  images = x.pescapejs('images');
                  accumulate(scoresTotal, images, 0);  // Makes each image show up, even if not annotated
                  if (_.isUndefined(d))
                      return;
                  if (d.polarity) {
                      accumulate(scoresPos, pick(d.selected, images), 1);
                      if (scoreUnselected)
                          accumulate(scoresNeg, pick(d.notSelected, images), 1);
                  } else {
                      accumulate(scoresNeg, pick(d.selected, images), 1);
                      if (scoreUnselected)
                          accumulate(scoresPos, pick(d.notSelected, images), 1);
                  }
              });
              _.each(scoresPos, function (y, x) {
                  if (_.has(scoresTotal, x)) {
                      scoresTotal[x] += y;
                  } else {
                      scoresTotal[x] = y;
                  }
              });
              _.each(scoresNeg, function (y, x) {
                  if (_.has(scoresTotal, x)) {
                      scoresTotal[x] += y;
                  } else {
                      scoresTotal[x] = y;
                  }
              });
              return {scoresPos: scoresPos, scoresNeg: scoresNeg, scoresTotal: scoresTotal};
          }
          function change() {
              var task = $('#annotator_select').find(":selected").val();
              if (_.isUndefined(task)) {
      return;
              }
              task = decode_id(task);
              // TODO: Add dropdown to select annotator to query
              // TODO: Histogram of annotation times, annotation time vs annotation iteration (scatter and median), histogram of image annotations
              // TODO: Abstract functions for getting image annotations based on annotation type
              // TODO: Filter rows and/or modify column based on annotation
              // TODO: Add voting rules for neg/pos/unsure
              // TODO: Add other annotation types
              var results = new PicarusRows([], {'table': 'annotations-results-' + task});
              var users = new PicarusRows([], {'table': 'annotations-users-' + task});
              var imageColumn = encode_id('thum:image_150sq');
              $('#negPct').change(data_change);
              $('#posPct').change(data_change);
              $('#posCnt').change(data_change);
              $('#negCnt').change(data_change);
              $('#unclicked').change(data_change);
              function data_change() {
                  negPct = Number($('#negPct').val());
                  posPct = Number($('#posPct').val());
                  negCnt = Math.max(1, Number($('#negCnt').val()));
                  posCnt = Math.max(1, Number($('#posCnt').val()));
                  unclicked = $('#unclicked').is(':checked')
                  scores = image_batch_score(users, results, unclicked);
                  ts = scores.scoresTotal;
                  posScores = _.sortBy(_.filter(_.pairs(scores.scoresPos), function (x) {return x[1] >= posCnt && (x[1] / ts[x[0]]) >= posPct}), function (x) { return -x[1] });
                  negScores = _.sortBy(_.filter(_.pairs(scores.scoresNeg), function (x) {return x[1] >= negCnt && (x[1] / ts[x[0]]) >= negPct}), function (x) { return x[1] });
                  os = _.omit(_.omit(ts, _.keys(scores.scoresPos)), _.keys(scores.scoresNeg));
                  otherScores = _.shuffle(_.pairs(os));
                  function display_samples(div, scores, title) {
                      div.html('');
                      div.append($('<h3>').text(title + ' ' + scores.length + ' / ' + _.size(ts)));

                      _.each(scores.slice(0, 24), function (x) {
                      var id = _.uniqueId('image_');
                          div.append($('<img>').attr('id', id).attr('title', 'Row: ' + x[0] + ' Score: ' + x[1]).addClass('hide'));
                          function success(xhr) {
                              response = JSON.parse(xhr.responseText);
                              if (_.isUndefined(response[imageColumn]))
                                  return;
                              $('#' + id).attr('src', 'data:image/jpeg;base64,' + response[imageColumn]).attr('width', '150px').removeClass('hide');
                          }
                          picarus_api("/a1/data/images/" + x[0], "GET", {success: success, data: {columns: imageColumn}});
                      });
                  }
                  display_samples($('#positive_samples'), posScores, 'Positive Samples');
                  display_samples($('#negative_samples'), negScores, 'Negative Samples');
                  display_samples($('#other_samples'), otherScores, 'Other Samples (not pos/neg)');

                  // Hookup delete
                  function delete_row() {
                      action = $('#actionSplit').find(":selected").val();
                      delKeys = _.keys(_.object({'positive': posScores, 'negative': negScores, 'other': otherScores}[action]));
                      picarus_api_delete_rows(delKeys, progressModal());
                      button_confirm_click_reset($('#removeButton'));
                      button_confirm_click($('#removeButton'), delete_row);
                  }
                  button_confirm_click($('#removeButton'), delete_row);
                  // Hookup modify
                  function modify_row() {
                      var action = $('#actionSplit').find(":selected").val();
                      var modifyKeys = _.keys(_.object({'positive': posScores, 'negative': negScores, 'other': otherScores}[action]));
                      picarus_api_modify_rows(modifyKeys, $('#colName').val(), $('#colValue').val(), progressModal());
                      button_confirm_click_reset($('#modifyButton'));
                      button_confirm_click($('#modifyButton'), modify_row);
                  }
                  button_confirm_click($('#modifyButton'), modify_row);
                  $('#actionSplit').change(change_actions);
                  function change_actions () {
                      button_confirm_click_reset($('#removeButton'));
                      button_confirm_click($('#removeButton'), delete_row);
                      button_confirm_click_reset($('#modifyButton'));
                      button_confirm_click($('#modifyButton'), modify_row);
                  }
              }

              new RowsView({collection: results, el: $('#annotation-results'), postRender: _.debounce(data_change, 100)});
              results.fetch();

              new RowsView({collection: users, el: $('#annotation-users'), postRender: _.debounce(data_change, 100)});
              users.fetch();
          }
          rows_dropdown(rows, {el: $('#annotator_select'), text: function (x) {return x.pescapejs('params').query}, change: change});
          rows.fetch();
      }
    </script>

    <!--<script type="text/html" id="tpl_docs_filters">
      <h3>Only output rows where column meta:class is exactly equal to 'dinner'</h3>
      <pre>SingleColumnValueFilter ('meta', 'class', =, 'binary:dinner')</pre>
    </script>
</div>-->
<div class="container">
    <div class="navbar navbar-inverse">
      <div class="navbar-inner">
        <div class="container">
          <div class="brand" style="padding-bottom: 12px; padding-top: 13px;"><img src="/static/picarus_small.svg" width="44px"\> picar.us</div>
          <div class="nav-collapse collapse">
            <!-- NAV BAR ITEM AREA -->
            <ul id="nav-item-container" class="nav"></ul>
          </div>
        </div>
      </div>
    </div>
    <div id="authModal" class="modal hide fade" data-keyboard="false" tabindex="-1" role="dialog" aria-labelledby="authModalLabel" aria-hidden="true">
      <div class="modal-header">
        <h3>Authenticate</h3>
      </div>
      <div class="modal-body">
        <div class="well" id="secondFactorAuth">
          <div class="control-group"><input class="input-large" type="password" placeholder="Yubikey" id="otp" value="" disabled></div><div style="padding-bottom: 5px">OR</div><div class="control-group"><input class="input-large" type="password" placeholder="API Key" id="apiKey" value=""disabled><a class="login-link" style="padding-left: 5px" id="emailKeys" href="#">Need an API key?  Click to email.</a></div>
        </div>
        <div style="padding-bottom: 10px">
          AND
        </div>
        <div  class="well">
          <div><input class="input-large" type="text" placeholder="Email" id="email" value=""><span class="help-inline">Email</span></div>
          <div><input class="input-large" type="password" placeholder="Login Key" id="loginKey" value=""><span class="help-inline">Login Key</span></div>
        </div>
      </div>
    </div>
    <div id="progressModal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
      <div class="modal-header">
        <h3>Processing</h3>
      </div>
      <div class="modal-body">
        <div class="progress progress-striped active" id="progressBar">
          <div class="bar" style="width: 0%;"  id="progress"></div>
        </div>
      </div>
    </div>
    <div id="container" style="min-height:500px;width:940px;border:solid;overflow:auto; overflow-y:hidden"></div>
    </div>
    <script type="text/javascript">
      $(document).ready(app_main);
      google.load("visualization", "1", {packages:["corechart"]});
    </script>
  </body>
</html>
